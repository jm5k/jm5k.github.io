<!DOCTYPE html>
<html lang="en" data-theme="technolust">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0" />

    <title>Temporal Forge | Linear Clock Lab</title>
    <meta
      name="description"
      content="Temporal Forge ‚Äî an idle time-smelting game for Linear Clock Lab. Turn real-world seconds into Time Ore, Alloys, Chrono Bars, and Epoch Cores with upgrades, crits, milestones, and time boosts."
    />
    <meta
      name="keywords"
      content="idle game, incremental game, temporal forge, time smelter, linear clock lab, jm5k"
    />
    <meta name="author" content="jm5k" />
    <meta name="robots" content="index, follow" />

    <style>
      :root {
        --bg: #000;
        --fg: #e0e0e0;
        --muted: #9aa0aa;
        --accent: #00ffff;
        --accent-soft: rgba(0, 255, 255, 0.15);
        --rail: #111;
        --rail-border: #333;
        --card: #05060a;
        --card-border: #222;
        --danger: #ff4f4f;
        --success: #7bff7b;
        --shadow-soft: 0 0 30px rgba(0, 255, 255, 0.15);
        --radius-lg: 14px;
        --radius-sm: 8px;
        --transition-fast: 0.15s ease-out;
        --font-main: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
          sans-serif;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        padding: 0;
        min-height: 100vh;
        background: radial-gradient(
          circle at top,
          #050815 0,
          #000 40%,
          #000 100%
        );
        color: var(--fg);
        font-family: var(--font-main);
        display: flex;
        flex-direction: column;
      }

      a {
        color: var(--accent);
        text-decoration: none;
      }

      a:hover {
        text-decoration: underline;
      }

      header {
        padding: 16px 6vw 8px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
      }

      header .title-block {
        display: flex;
        flex-direction: column;
        gap: 2px;
      }

      header h1 {
        font-size: 1.4rem;
        letter-spacing: 0.06em;
        text-transform: uppercase;
        margin: 0;
      }

      header p {
        margin: 0;
        font-size: 0.85rem;
        color: var(--muted);
      }

      .nav-link {
        font-size: 0.8rem;
        padding: 6px 10px;
        border-radius: 999px;
        border: 1px solid var(--accent);
        background: rgba(0, 0, 0, 0.6);
        display: inline-flex;
        align-items: center;
        gap: 6px;
        text-decoration: none;
        box-shadow: 0 0 12px rgba(0, 255, 255, 0.2);
      }

      .nav-link span {
        font-size: 0.9rem;
      }

      main {
        padding: 0 6vw 24px;
        max-width: 1200px;
        width: 100%;
        margin: 0 auto 16px;
      }

      /* 24-hour rail */
      .day-rail {
        margin: 4px 0 20px;
        padding: 10px 0 12px;
      }

      .rail-label {
        display: flex;
        justify-content: space-between;
        font-size: 0.75rem;
        color: var(--muted);
        margin-bottom: 6px;
      }

      .rail-track {
        position: relative;
        height: 12px;
        border-radius: 999px;
        background: var(--rail);
        border: 1px solid var(--rail-border);
        overflow: hidden;
        box-shadow: var(--shadow-soft);
      }

      .rail-fill {
        position: absolute;
        inset: 0;
        background: linear-gradient(
          90deg,
          rgba(0, 255, 255, 0.2),
          rgba(0, 255, 255, 0.9),
          rgba(0, 255, 255, 0.2)
        );
        transform-origin: left center;
        transform: scaleX(0);
        transition: transform 0.4s ease-out;
      }

      .rail-marker {
        position: absolute;
        top: 50%;
        width: 3px;
        height: 22px;
        background: var(--accent);
        box-shadow: 0 0 10px rgba(0, 255, 255, 0.9);
        transform: translate(-50%, -50%);
      }

      .rail-meta {
        margin-top: 4px;
        display: flex;
        justify-content: space-between;
        font-size: 0.75rem;
        color: var(--muted);
      }

      /* Layout */
      .grid {
        display: grid;
        grid-template-columns: minmax(0, 1.2fr) minmax(0, 1fr);
        gap: 18px;
      }

      @media (max-width: 900px) {
        .grid {
          grid-template-columns: minmax(0, 1fr);
        }
      }

      .card {
        background: linear-gradient(
          145deg,
          #05060a 0,
          #050816 60%,
          #05060a 100%
        );
        border-radius: var(--radius-lg);
        padding: 14px 16px 16px;
        border: 1px solid var(--card-border);
        box-shadow: 0 0 18px rgba(0, 0, 0, 0.7);
      }

      .card h2 {
        font-size: 1rem;
        text-transform: uppercase;
        letter-spacing: 0.14em;
        color: var(--muted);
        margin: 0 0 10px;
      }

      .card small {
        font-size: 0.75rem;
        color: var(--muted);
      }

      .resources {
        display: grid;
        grid-template-columns: repeat(4, minmax(0, 1fr));
        gap: 8px;
        margin: 10px 0 12px;
      }

      @media (max-width: 800px) {
        .resources {
          grid-template-columns: repeat(2, minmax(0, 1fr));
        }
      }

      .res-pill {
        border-radius: var(--radius-sm);
        border: 1px solid var(--card-border);
        padding: 8px 9px;
        background: radial-gradient(circle at top left, #0a1018, #05060a);
        display: flex;
        flex-direction: column;
        gap: 3px;
        position: relative;
      }

      .res-pill.celebrate {
        box-shadow: 0 0 18px rgba(0, 255, 255, 0.7);
        border-color: rgba(0, 255, 255, 0.9);
      }

      .res-label {
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 0.75rem;
        color: var(--muted);
      }

      .res-label span.key {
        text-transform: uppercase;
        letter-spacing: 0.12em;
      }

      .res-label span.badge {
        padding: 2px 6px;
        border-radius: 999px;
        border: 1px solid rgba(0, 255, 255, 0.4);
        color: var(--accent);
        font-size: 0.7rem;
      }

      .res-value {
        font-size: 1.05rem;
        font-variant-numeric: tabular-nums;
      }

      .res-value strong {
        color: var(--accent);
      }

      .res-rate {
        font-size: 0.7rem;
        color: var(--muted);
      }

      .actions-block {
        margin-top: 4px;
        border-top: 1px dashed rgba(120, 130, 140, 0.5);
        padding-top: 8px;
        display: grid;
        grid-template-columns: minmax(0, 1fr);
        gap: 8px;
      }

      .action-row {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        align-items: center;
      }

      .action-label {
        font-size: 0.75rem;
        color: var(--muted);
      }

      button {
        cursor: pointer;
        border-radius: 999px;
        border: 1px solid var(--card-border);
        background: rgba(0, 0, 0, 0.6);
        color: var(--fg);
        padding: 6px 11px;
        font-size: 0.8rem;
        font-family: inherit;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        transition: background var(--transition-fast),
          border-color var(--transition-fast), transform var(--transition-fast),
          box-shadow var(--transition-fast), opacity var(--transition-fast);
        white-space: nowrap;
      }

      button span.hotkey {
        opacity: 0.7;
        font-size: 0.7rem;
      }

      button.primary {
        border-color: rgba(0, 255, 255, 0.8);
        box-shadow: 0 0 14px rgba(0, 255, 255, 0.25);
      }

      button.primary:hover:not(:disabled) {
        background: linear-gradient(90deg, #041f24, #062a32);
        transform: translateY(-1px);
      }

      button.secondary:hover:not(:disabled) {
        background: rgba(255, 255, 255, 0.06);
        transform: translateY(-1px);
      }

      button:disabled {
        opacity: 0.4;
        cursor: default;
        box-shadow: none;
      }

      .forge-meta,
      .epoch-meta,
      .boost-meta,
      .auto-meta {
        font-size: 0.72rem;
        color: var(--muted);
      }

      .forge-meta span.ready,
      .epoch-meta span.ready {
        color: var(--success);
      }

      .boost-meta span.status {
        color: var(--accent);
      }

      .smelt-log {
        margin-top: 8px;
        padding-top: 6px;
        border-top: 1px dashed rgba(120, 130, 140, 0.5);
        font-size: 0.72rem;
        color: var(--muted);
        max-height: 96px;
        overflow-y: auto;
        overflow-x: hidden;
      }

      .smelt-log-line {
        opacity: 0.85;
      }

      .smelt-log-line + .smelt-log-line {
        margin-top: 2px;
      }

      .smelt-log-line span.highlight {
        color: var(--accent);
      }

      .smelt-log-line span.success {
        color: var(--success);
      }

      .smelt-log-line span.danger {
        color: var(--danger);
      }

      .smelt-log-line span.crit {
        color: #ffd966;
      }

      /* Upgrades */
      .upgrades-list {
        display: flex;
        flex-direction: column;
        gap: 6px;
        margin-top: 6px;
      }

      .upgrade {
        border-radius: var(--radius-sm);
        border: 1px solid var(--card-border);
        padding: 7px 9px;
        display: grid;
        grid-template-columns: minmax(0, 1.4fr) auto;
        gap: 6px;
        background: radial-gradient(circle at top left, #070b10, #05060a);
      }

      .upgrade-header {
        font-size: 0.82rem;
        display: flex;
        flex-direction: column;
        gap: 2px;
      }

      .upgrade-header strong {
        letter-spacing: 0.06em;
        text-transform: uppercase;
        font-size: 0.76rem;
        color: var(--accent);
      }

      .upgrade-header span.desc {
        color: var(--muted);
        font-size: 0.75rem;
      }

      .upgrade-meta {
        font-size: 0.7rem;
        color: var(--muted);
      }

      .upgrade-meta span.cost {
        color: var(--accent);
      }

      .upgrade-meta span.level {
        color: var(--success);
      }

      .upgrade-actions {
        display: flex;
        align-items: center;
        justify-content: flex-end;
      }

      /* Footer */
      footer {
        padding: 10px 6vw 14px;
        border-top: 1px solid #111;
        font-size: 0.75rem;
        color: var(--muted);
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 8px;
      }

      .save-status {
        font-size: 0.72rem;
        opacity: 0.8;
      }

      .save-status span {
        color: var(--accent);
      }

      .danger-link {
        color: var(--danger);
        cursor: pointer;
        text-decoration: underline;
      }

      @media (max-width: 600px) {
        header {
          flex-direction: column;
          align-items: flex-start;
        }

        footer {
          flex-direction: column;
          align-items: flex-start;
        }
      }
    </style>
  </head>
  <body>
    <header>
      <div class="title-block">
        <h1>Temporal Forge</h1>
        <p>
          Smelt real-world seconds into alloys, Chrono Bars, and Epoch Cores ‚Äî
          with crits, milestones, and time boosts.
        </p>
      </div>
      <a class="nav-link" href="index.html">
        <span>‚Üê</span>
        <span>Back to Linear Clock Lab</span>
      </a>
    </header>

    <main>
      <!-- Day Rail -->
      <section class="day-rail">
        <div class="rail-label">
          <span>24-Hour Continuum</span>
          <span id="rail-time-label">--:--:--</span>
        </div>
        <div class="rail-track">
          <div class="rail-fill" id="rail-fill"></div>
          <div class="rail-marker" id="rail-marker" style="left: 0%"></div>
        </div>
        <div class="rail-meta">
          <span id="rail-day-percent">Day progress: --%</span>
          <span id="rail-remaining">Remaining: --:--:--</span>
        </div>
      </section>

      <section class="grid">
        <!-- LEFT: Resources & Actions -->
        <section class="card">
          <h2>Smelter Core</h2>
          <small
            >Time flows even when this tab is in the background. Your forge
            catches up when you return.</small
          >

          <div class="resources">
            <div class="res-pill" id="pill-ore">
              <div class="res-label">
                <span class="key">Time Ore</span>
                <span class="badge">Tier I</span>
              </div>
              <div class="res-value">
                <strong id="ore-count">0</strong>
              </div>
              <div class="res-rate">
                Generation: <span id="ore-rate">0 /s</span>
                <span id="ore-rate-boost"></span>
              </div>
            </div>

            <div class="res-pill" id="pill-alloy">
              <div class="res-label">
                <span class="key">Alloys</span>
                <span class="badge">Tier II</span>
              </div>
              <div class="res-value">
                <strong id="alloy-count">0</strong>
              </div>
              <div class="res-rate">
                Auto Smelt: <span id="alloy-rate">0 /s</span>
              </div>
            </div>

            <div class="res-pill" id="pill-bar">
              <div class="res-label">
                <span class="key">Chrono Bars</span>
                <span class="badge">Tier III</span>
              </div>
              <div class="res-value">
                <strong id="bar-count">0</strong>
              </div>
              <div class="res-rate">
                Forge Power: <span id="bar-mult">x1.0</span>
              </div>
            </div>

            <div class="res-pill" id="pill-epoch">
              <div class="res-label">
                <span class="key">Epoch Cores</span>
                <span class="badge">Tier IV</span>
              </div>
              <div class="res-value">
                <strong id="epoch-count">0</strong>
              </div>
              <div class="res-rate">Formed from Chrono Bars.</div>
            </div>
          </div>

          <div class="actions-block">
            <!-- Smelting -->
            <div class="action-row">
              <div class="action-label">Smelting</div>
              <button
                id="btn-smelt"
                class="secondary"
                title="Convert 60 Time Ore into 1 Alloy. Hotkey: S"
              >
                üî• Smelt 60 Ore ‚Üí 1 Alloy <span class="hotkey">(S)</span>
              </button>
            </div>

            <!-- Forge Bars -->
            <div class="action-row">
              <div class="action-label">Forge Station</div>
              <button
                id="btn-forge"
                class="primary"
                title="Forge Chrono Bars by spending Alloys. Hotkey: F"
              >
                üî® Forge Chrono Bars (60 Alloys) <span class="hotkey">(F)</span>
              </button>
            </div>

            <div class="forge-meta">
              Ready for forge:
              <span class="ready" id="forge-ready-count">0</span>
              possible use(s) right now.
            </div>

            <!-- Forge Epoch Cores -->
            <div class="action-row">
              <div class="action-label">Epoch Crucible</div>
              <button
                id="btn-epoch"
                class="primary"
                title="Cast an Epoch Core from Chrono Bars."
              >
                ‚ú® Cast Epoch Core (12 Chrono Bars)
              </button>
            </div>
            <div class="epoch-meta">
              Ready for cast:
              <span class="ready" id="epoch-ready-count">0</span>
              possible core(s) right now.
            </div>

            <!-- Auto Smelter Toggle -->
            <div class="action-row">
              <div class="action-label">Automation</div>
              <button
                id="btn-toggle-auto"
                class="secondary"
                title="Toggle automatic smelting of Ore into Alloys. Unlocks with tier2automation upgrade."
              >
                Auto Smelter: Locked
              </button>
            </div>
            <div class="auto-meta">
              Auto Smelter converts <span class="highlight">Time Ore</span> into
              <span class="highlight">Alloys</span> when enabled. Turn it off if
              you want to stockpile Ore for upgrades.
            </div>

            <!-- Time Boosts -->
            <div class="action-row">
              <div class="action-label">Temporal Boosts</div>
              <button
                id="btn-time-surge"
                class="secondary"
                title="Temporarily triples Time Ore generation."
              >
                ‚ö° Time Surge (+300% Ore/sec, 20s)
              </button>
            </div>
            <div class="boost-meta">
              Surge status:
              <span class="status" id="time-surge-status">Ready</span>
            </div>
          </div>

          <div class="smelt-log" id="log">
            <div class="smelt-log-line">
              Forge initialized. <span class="highlight">Time Ore</span> will
              accumulate as long as this save exists.
            </div>
          </div>
        </section>

        <!-- RIGHT: Upgrades -->
        <section class="card">
          <h2>Upgrades</h2>
          <small
            >Crits, milestones, and automation push your forge forward.</small
          >

          <div class="upgrades-list" id="upgrades-list">
            <article class="upgrade" data-upgrade-id="tier1generation">
              <div>
                <div class="upgrade-header">
                  <strong>Faster Drilling</strong>
                  <span class="desc"
                    >Boosts Time Ore (Tier I) generation per second.</span
                  >
                </div>
                <div class="upgrade-meta">
                  Cost: <span class="cost" data-cost-label>120 Time Ore</span> ¬∑
                  Level: <span class="level" data-level-label>0</span>
                </div>
              </div>
              <div class="upgrade-actions">
                <button class="primary" data-upgrade-button>Upgrade</button>
              </div>
            </article>

            <article class="upgrade" data-upgrade-id="tier2automation">
              <div>
                <div class="upgrade-header">
                  <strong>Auto Smelter</strong>
                  <span class="desc"
                    >Automatically smelts Time Ore into Alloys over time.</span
                  >
                </div>
                <div class="upgrade-meta">
                  Cost: <span class="cost" data-cost-label>5 Alloys</span> ¬∑
                  Level: <span class="level" data-level-label>0</span>
                </div>
              </div>
              <div class="upgrade-actions">
                <button class="secondary" data-upgrade-button>Upgrade</button>
              </div>
            </article>

            <article class="upgrade" data-upgrade-id="tier3efficiency">
              <div>
                <div class="upgrade-header">
                  <strong>Efficient Forge</strong>
                  <span class="desc"
                    >Each forge action creates more Chrono Bars.</span
                  >
                </div>
                <div class="upgrade-meta">
                  Cost: <span class="cost" data-cost-label>10 Alloys</span> ¬∑
                  Level: <span class="level" data-level-label>0</span>
                </div>
              </div>
              <div class="upgrade-actions">
                <button class="secondary" data-upgrade-button>Upgrade</button>
              </div>
            </article>
          </div>
        </section>
      </section>
    </main>

    <footer>
      <div class="save-status" id="save-status">Save: <span>Ready</span></div>
      <div>
        <span
          >¬© jm5k 2025 ‚Äî Temporal Forge, a Linear Clock Lab experiment.</span
        >
        &nbsp;¬∑&nbsp;
        <span class="danger-link" id="reset-save">Reset Forge</span>
      </div>
    </footer>

    <script>
      (function () {
        const SAVE_KEY = "TemporalForgeSave_v3";
        const DEV_MODE = true; // Set to false for production

        // Resource UI elements (still named after lore terms)
        const oreEl = document.getElementById("ore-count");
        const alloyEl = document.getElementById("alloy-count");
        const barEl = document.getElementById("bar-count");
        const epochEl = document.getElementById("epoch-count");
        const oreRateEl = document.getElementById("ore-rate");
        const oreRateBoostEl = document.getElementById("ore-rate-boost");
        const alloyRateEl = document.getElementById("alloy-rate");
        const barMultEl = document.getElementById("bar-mult");
        const logEl = document.getElementById("log");
        const saveStatusEl = document.getElementById("save-status");

        const btnSmelt = document.getElementById("btn-smelt");
        const btnForge = document.getElementById("btn-forge");
        const btnEpoch = document.getElementById("btn-epoch");
        const btnTimeSurge = document.getElementById("btn-time-surge");
        const btnToggleAuto = document.getElementById("btn-toggle-auto");

        const forgeReadyEl = document.getElementById("forge-ready-count");
        const epochReadyEl = document.getElementById("epoch-ready-count");
        const timeSurgeStatusEl = document.getElementById("time-surge-status");

        const resetBtn = document.getElementById("reset-save");

        const railFill = document.getElementById("rail-fill");
        const railMarker = document.getElementById("rail-marker");
        const railTimeLabel = document.getElementById("rail-time-label");
        const railDayPercent = document.getElementById("rail-day-percent");
        const railRemaining = document.getElementById("rail-remaining");

        const upgradesListEl = document.getElementById("upgrades-list");

        const pillOre = document.getElementById("pill-ore");
        const pillAlloy = document.getElementById("pill-alloy");
        const pillBar = document.getElementById("pill-bar");
        const pillEpoch = document.getElementById("pill-epoch");

        // Generic tier economy
        const TIER1_PER_TIER2 = 60; // 60 Time Ore ‚Üí 1 Alloy
        const TIER2_PER_TIER3 = 60; // 60 Alloys ‚Üí 1 Chrono Bar (before multipliers)
        const TIER3_PER_TIER4 = 12; // 12 Bars ‚Üí 1 Epoch Core

        // Crit chances
        const CRIT_SMELT_CHANCE = 0.05;
        const CRIT_FORGE_CHANCE = 0.05;
        const CRIT_SMELT_MULTIPLIER = 3;
        const CRIT_FORGE_MULTIPLIER = 3;

        // Time Surge
        const SURGE_MULTIPLIER = 3;
        const SURGE_DURATION = 20; // seconds
        const SURGE_COOLDOWN = 300; // seconds

        let state = {
          // Tiers: internal generic bones
          tier1resource: 0, // Time Ore
          tier2resource: 0, // Alloys
          tier3resource: 0, // Chrono Bars
          tier4resource: 0, // Epoch Cores

          tier1BaseRate: 1,
          tier1BonusRate: 0,
          tier2AutomationRate: 0, // alloys/sec if enabled and enough tier1
          tier2AutomationEnabled: false,
          tier3Multiplier: 1,

          upgrades: {
            tier1generation: 0,
            tier2automation: 0,
            tier3efficiency: 0,
          },

          totals: {
            tier1Generated: 0,
            tier2Generated: 0,
            tier3Generated: 0,
            tier4Generated: 0,
          },

          milestones: {
            tier1_10k: false,
            tier1_100k: false,
            tier1_1m: false,
            tier2_100: false,
            tier2_500: false,
            tier2_2k: false,
            tier3_10: false,
            tier3_50: false,
            tier3_200: false,
            tier4_1: false,
            tier4_3: false,
            tier4_10: false,
          },

          boosts: {
            timeSurge: {
              active: false,
              remaining: 0,
              cooldown: 0,
            },
          },

          lastUpdate: Date.now(),
        };

        const upgradeDefs = {
          tier1generation: {
            baseCost: 120,
            costScale: 1.65,
            currency: "tier1", // Time Ore
            bonusPerLevel: 0.4, // +0.4 tier1/s
            label: "Time Ore",
          },
          tier2automation: {
            baseCost: 5,
            costScale: 2,
            currency: "tier2", // Alloys
            bonusPerLevel: 0.2, // +0.2 Alloys/s
            label: "Alloys",
          },
          tier3efficiency: {
            baseCost: 10,
            costScale: 2.1,
            currency: "tier2", // Alloys
            bonusPerLevel: 0.3, // +0.3x forge multiplier
            label: "Alloys",
          },
        };

        function formatNumber(value) {
          // Always show, at most, what you actually have
          const v = Math.floor(value + 1e-9); // tiny epsilon to calm float noise

          if (v < 1000) return v.toString();
          if (v < 1000000)
            return v.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
          return v.toExponential(2);
        }

        function formatTime(h, m, s) {
          const pad = (n) => String(n).padStart(2, "0");
          return pad(h) + ":" + pad(m) + ":" + pad(s);
        }

        function randomChance(p) {
          return Math.random() < p;
        }

        function flashPill(el) {
          el.classList.add("celebrate");
          setTimeout(() => el.classList.remove("celebrate"), 350);
        }

        function appendLog(messageHtml) {
          const line = document.createElement("div");
          line.className = "smelt-log-line";
          line.innerHTML = messageHtml;
          logEl.insertBefore(line, logEl.firstChild);
          while (logEl.children.length > 10) {
            logEl.removeChild(logEl.lastChild);
          }
        }

        function saveState() {
          try {
            const data = { ...state, lastUpdate: Date.now() };
            localStorage.setItem(SAVE_KEY, JSON.stringify(data));
            saveStatusEl.innerHTML = "Save: <span>OK</span>";
          } catch (e) {
            console.error("Save error", e);
            saveStatusEl.innerHTML =
              'Save: <span style="color:#ff4f4f">Error</span>';
          }
        }

        function loadState() {
          try {
            const raw = localStorage.getItem(SAVE_KEY);
            if (!raw) {
              state.lastUpdate = Date.now();
              return;
            }
            const data = JSON.parse(raw);
            state = {
              ...state,
              ...data,
              upgrades: { ...state.upgrades, ...(data.upgrades || {}) },
              totals: { ...state.totals, ...(data.totals || {}) },
              milestones: { ...state.milestones, ...(data.milestones || {}) },
              boosts: { ...state.boosts, ...(data.boosts || {}) },
            };
            appendLog(
              `<span class="success">Loaded existing forge state.</span> You kept earning <span class="highlight">Time Ore</span> since your last visit.`
            );
          } catch (e) {
            console.error("Load error", e);
            appendLog(
              `<span class="danger">Save data corrupted.</span> A fresh forge has been initialized.`
            );
          } finally {
            state.lastUpdate = Date.now();
          }
        }

        function resetState() {
          localStorage.removeItem(SAVE_KEY);
          state = {
            tier1resource: 0,
            tier2resource: 0,
            tier3resource: 0,
            tier4resource: 0,
            tier1BaseRate: 1,
            tier1BonusRate: 0,
            tier2AutomationRate: 0,
            tier2AutomationEnabled: false,
            tier3Multiplier: 1,
            upgrades: {
              tier1generation: 0,
              tier2automation: 0,
              tier3efficiency: 0,
            },
            totals: {
              tier1Generated: 0,
              tier2Generated: 0,
              tier3Generated: 0,
              tier4Generated: 0,
            },
            milestones: {
              tier1_10k: false,
              tier1_100k: false,
              tier1_1m: false,
              tier2_100: false,
              tier2_500: false,
              tier2_2k: false,
              tier3_10: false,
              tier3_50: false,
              tier3_200: false,
              tier4_1: false,
              tier4_3: false,
              tier4_10: false,
            },
            boosts: {
              timeSurge: {
                active: false,
                remaining: 0,
                cooldown: 0,
              },
            },
            lastUpdate: Date.now(),
          };
          appendLog(
            `<span class="danger">Forge reset.</span> All resources, milestones, and upgrades cleared.`
          );
          updateUI();
          saveState();
        }

        function computeDayRail() {
          const now = new Date();
          const h = now.getHours();
          const m = now.getMinutes();
          const s = now.getSeconds();

          const secondsToday = h * 3600 + m * 60 + s;
          const total = 24 * 3600;
          const ratio = secondsToday / total;
          const percent = ratio * 100;

          railFill.style.transform = `scaleX(${ratio})`;
          railMarker.style.left = `${percent}%`;

          railTimeLabel.textContent = formatTime(h, m, s);
          railDayPercent.textContent =
            "Day progress: " + percent.toFixed(1) + "%";

          const remaining = total - secondsToday;
          const rh = Math.floor(remaining / 3600);
          const rm = Math.floor((remaining % 3600) / 60);
          const rs = remaining % 60;

          railRemaining.textContent = "Remaining: " + formatTime(rh, rm, rs);
        }

        function checkMilestones() {
          const t = state.totals;
          const m = state.milestones;

          // Tier1 (Time Ore) milestones
          if (!m.tier1_10k && t.tier1Generated >= 10000) {
            m.tier1_10k = true;
            state.tier1BonusRate += 0.5;
            flashPill(pillOre);
            appendLog(
              `<span class="success">Milestone unlocked:</span> Smelted 10,000 Time Ore. Permanent Ore rate +<span class="highlight">0.5/s</span>.`
            );
          }
          if (!m.tier1_100k && t.tier1Generated >= 100000) {
            m.tier1_100k = true;
            state.tier1BonusRate += 1.0;
            flashPill(pillOre);
            appendLog(
              `<span class="success">Milestone unlocked:</span> Smelted 100,000 Time Ore. Permanent Ore rate +<span class="highlight">1.0/s</span>.`
            );
          }
          if (!m.tier1_1m && t.tier1Generated >= 1000000) {
            m.tier1_1m = true;
            state.tier1BonusRate += 2.0;
            flashPill(pillOre);
            appendLog(
              `<span class="success">Milestone unlocked:</span> Smelted 1,000,000 Time Ore. Permanent Ore rate +<span class="highlight">2.0/s</span>.`
            );
          }

          // Tier2 (Alloys) milestones
          if (!m.tier2_100 && t.tier2Generated >= 100) {
            m.tier2_100 = true;
            state.tier2AutomationRate += 0.1;
            flashPill(pillAlloy);
            appendLog(
              `<span class="success">Milestone unlocked:</span> Smelted 100 Alloys. Auto Smelt +<span class="highlight">0.10/s</span>.`
            );
          }
          if (!m.tier2_500 && t.tier2Generated >= 500) {
            m.tier2_500 = true;
            state.tier2AutomationRate += 0.2;
            flashPill(pillAlloy);
            appendLog(
              `<span class="success">Milestone unlocked:</span> Smelted 500 Alloys. Auto Smelt +<span class="highlight">0.20/s</span>.`
            );
          }
          if (!m.tier2_2k && t.tier2Generated >= 2000) {
            m.tier2_2k = true;
            state.tier2AutomationRate += 0.4;
            flashPill(pillAlloy);
            appendLog(
              `<span class="success">Milestone unlocked:</span> Smelted 2,000 Alloys. Auto Smelt +<span class="highlight">0.40/s</span>.`
            );
          }

          // Tier3 (Bars) milestones
          if (!m.tier3_10 && t.tier3Generated >= 10) {
            m.tier3_10 = true;
            state.tier3Multiplier += 0.3;
            flashPill(pillBar);
            appendLog(
              `<span class="success">Milestone unlocked:</span> Forged 10 Chrono Bars. Forge multiplier +<span class="highlight">0.3x</span>.`
            );
          }
          if (!m.tier3_50 && t.tier3Generated >= 50) {
            m.tier3_50 = true;
            state.tier3Multiplier += 0.5;
            flashPill(pillBar);
            appendLog(
              `<span class="success">Milestone unlocked:</span> Forged 50 Chrono Bars. Forge multiplier +<span class="highlight">0.5x</span>.`
            );
          }
          if (!m.tier3_200 && t.tier3Generated >= 200) {
            m.tier3_200 = true;
            state.tier3Multiplier += 1.0;
            flashPill(pillBar);
            appendLog(
              `<span class="success">Milestone unlocked:</span> Forged 200 Chrono Bars. Forge multiplier +<span class="highlight">1.0x</span>.`
            );
          }

          // Tier4 (Epoch Cores) milestones
          if (!m.tier4_1 && t.tier4Generated >= 1) {
            m.tier4_1 = true;
            state.tier1BaseRate += 0.5;
            flashPill(pillEpoch);
            appendLog(
              `<span class="success">Epoch Milestone:</span> 1 Epoch Core forged. Base Ore rate +<span class="highlight">0.5/s</span>.`
            );
          }
          if (!m.tier4_3 && t.tier4Generated >= 3) {
            m.tier4_3 = true;
            state.tier1BaseRate += 1.0;
            state.tier2AutomationRate += 0.2;
            flashPill(pillEpoch);
            appendLog(
              `<span class="success">Epoch Milestone:</span> 3 Epoch Cores forged. Base Ore rate +<span class="highlight">1.0/s</span>, Auto Smelt +<span class="highlight">0.2/s</span>.`
            );
          }
          if (!m.tier4_10 && t.tier4Generated >= 10) {
            m.tier4_10 = true;
            state.tier3Multiplier += 1.5;
            flashPill(pillEpoch);
            appendLog(
              `<span class="success">Epoch Milestone:</span> 10 Epoch Cores forged. Forge multiplier +<span class="highlight">1.5x</span>.`
            );
          }
        }

        function updateAutoSmelterToggleUI() {
          const level = state.upgrades.tier2automation || 0;
          if (level <= 0) {
            btnToggleAuto.disabled = true;
            btnToggleAuto.textContent = "Auto Smelter: Locked";
          } else {
            btnToggleAuto.disabled = false;
            btnToggleAuto.textContent = state.tier2AutomationEnabled
              ? "Auto Smelter: ON"
              : "Auto Smelter: OFF";
          }
        }

        function updateUpgradesUI() {
          const upgradeEls = upgradesListEl.querySelectorAll(".upgrade");
          upgradeEls.forEach((el) => {
            const id = el.getAttribute("data-upgrade-id");
            const def = upgradeDefs[id];
            const level = state.upgrades[id] || 0;

            const cost = Math.round(
              def.baseCost * Math.pow(def.costScale, level)
            );

            const costLabel = el.querySelector("[data-cost-label]");
            const levelLabel = el.querySelector("[data-level-label]");
            const button = el.querySelector("[data-upgrade-button]");

            costLabel.textContent = `${cost} ${def.label}`;
            levelLabel.textContent = level;

            let affordable = false;
            if (def.currency === "tier1") {
              affordable = state.tier1resource >= cost;
            } else if (def.currency === "tier2") {
              affordable = state.tier2resource >= cost;
            }

            button.disabled = !affordable;
          });

          const baseOrePerSec = state.tier1BaseRate + state.tier1BonusRate;

          // Check if Time Surge is active
          const surgeActive = state.boosts.timeSurge?.active;
          const surgeMult = surgeActive ? SURGE_MULTIPLIER : 1;
          const boostedOrePerSec = baseOrePerSec * surgeMult;

          // Show base rate, and boosted info when active
          oreRateEl.textContent = baseOrePerSec.toFixed(2) + " /s";

          if (oreRateBoostEl) {
            if (surgeActive) {
              oreRateBoostEl.textContent = ` (BOOSTED ‚Üí ${boostedOrePerSec.toFixed(
                2
              )} /s)`;
              oreRateBoostEl.style.color = "#00ffff";
            } else {
              oreRateBoostEl.textContent = "";
            }
          }

          // Alloy auto-smelt rate (unchanged logic)
          const effectiveAutoRate = state.tier2AutomationEnabled
            ? state.tier2AutomationRate
            : 0;
          alloyRateEl.textContent = effectiveAutoRate.toFixed(2) + " /s";

          barMultEl.textContent = "x" + state.tier3Multiplier.toFixed(1);
          updateAutoSmelterToggleUI();
        }

        function updateForgeUI() {
          const possibleForges = Math.floor(
            state.tier2resource / TIER2_PER_TIER3
          );
          forgeReadyEl.textContent = possibleForges;
          btnForge.disabled = possibleForges <= 0;
          btnForge.title = possibleForges
            ? `Forge Chrono Bars using ${TIER2_PER_TIER3} Alloys. You can forge ${possibleForges} time(s) now. Hotkey: F`
            : `Not enough Alloys. Requires ${TIER2_PER_TIER3} Alloys per Forge. Hotkey: F`;
        }

        function updateEpochUI() {
          const possibleEpochs = Math.floor(
            state.tier3resource / TIER3_PER_TIER4
          );
          epochReadyEl.textContent = possibleEpochs;
          btnEpoch.disabled = possibleEpochs <= 0;
          btnEpoch.title = possibleEpochs
            ? `Cast an Epoch Core using ${TIER3_PER_TIER4} Chrono Bars. You can cast ${possibleEpochs} time(s) now.`
            : `Not enough Chrono Bars. Requires ${TIER3_PER_TIER4} Bars per Epoch Core.`;
        }

        function updateTimeSurgeUI() {
          const surge = state.boosts.timeSurge;
          if (surge.active) {
            timeSurgeStatusEl.textContent =
              "Active (" + Math.ceil(surge.remaining) + "s)";
            btnTimeSurge.disabled = true;
          } else if (surge.cooldown > 0) {
            timeSurgeStatusEl.textContent =
              "Cooldown (" + Math.ceil(surge.cooldown) + "s)";
            btnTimeSurge.disabled = true;
          } else {
            timeSurgeStatusEl.textContent = "Ready";
            btnTimeSurge.disabled = false;
          }
        }

        function updateUI() {
          // Map tier fields to lore UI
          oreEl.textContent = formatNumber(state.tier1resource);
          alloyEl.textContent = formatNumber(state.tier2resource);
          barEl.textContent = formatNumber(state.tier3resource);
          epochEl.textContent = formatNumber(state.tier4resource);

          updateUpgradesUI();
          updateForgeUI();
          updateEpochUI();
          updateTimeSurgeUI();
        }

        function updateBoostTimers(deltaSeconds) {
          const surge = state.boosts.timeSurge;
          if (surge.active) {
            surge.remaining -= deltaSeconds;
            if (surge.remaining <= 0) {
              surge.active = false;
              surge.remaining = 0;
              surge.cooldown = SURGE_COOLDOWN;
              appendLog(
                `<span class="highlight">Time Surge</span> has ended. Ore flow returns to normal.`
              );
            }
          } else if (surge.cooldown > 0) {
            surge.cooldown -= deltaSeconds;
            if (surge.cooldown < 0) surge.cooldown = 0;
          }
        }

        function processTick(deltaSeconds) {
          const surgeMult = state.boosts.timeSurge.active
            ? SURGE_MULTIPLIER
            : 1;

          const baseOrePerSec = state.tier1BaseRate + state.tier1BonusRate;
          const orePerSec = baseOrePerSec * surgeMult;

          const oreGain = orePerSec * deltaSeconds;
          state.tier1resource += oreGain;
          state.totals.tier1Generated += oreGain;

          const effectiveAutoRate = state.tier2AutomationEnabled
            ? state.tier2AutomationRate
            : 0;

          if (effectiveAutoRate > 0 && state.tier1resource > 0) {
            const potentialTier2 = effectiveAutoRate * deltaSeconds;
            const maxByTier1 = state.tier1resource / TIER1_PER_TIER2;
            const produced = Math.min(potentialTier2, maxByTier1);
            if (produced > 0) {
              state.tier1resource -= produced * TIER1_PER_TIER2;
              state.tier2resource += produced;
              state.totals.tier2Generated += produced;
            }
          }

          checkMilestones();
        }

        function gameLoop() {
          const now = Date.now();
          const deltaMs = now - state.lastUpdate;
          state.lastUpdate = now;

          const deltaSeconds = Math.max(0, deltaMs / 1000);
          if (deltaSeconds > 0) {
            processTick(deltaSeconds);
            updateBoostTimers(deltaSeconds);
            updateUI();
          }

          computeDayRail();
          requestAnimationFrame(gameLoop);
        }

        function smeltOre() {
          if (state.tier1resource < TIER1_PER_TIER2) {
            appendLog(
              `<span class="danger">Not enough Ore</span> ‚Äî need ${TIER1_PER_TIER2} Time Ore to smelt.`
            );
            return;
          }

          state.tier1resource -= TIER1_PER_TIER2;

          let gained = 1;
          let crit = false;
          if (randomChance(CRIT_SMELT_CHANCE)) {
            crit = true;
            gained = CRIT_SMELT_MULTIPLIER;
          }

          state.tier2resource += gained;
          state.totals.tier2Generated += gained;

          if (crit) {
            flashPill(pillAlloy);
            appendLog(
              `<span class="crit">Critical smelt!</span> ${TIER1_PER_TIER2} Ore ‚Üí <span class="success">${gained} Alloys</span>.`
            );
          } else {
            appendLog(
              `Manual smelt: <span class="highlight">${TIER1_PER_TIER2}</span> Ore ‚Üí <span class="success">${gained} Alloy${
                gained > 1 ? "s" : ""
              }</span>.`
            );
          }

          checkMilestones();
          updateUI();
          saveState();
        }

        function forgeBars() {
          if (state.tier2resource < TIER2_PER_TIER3) {
            appendLog(
              `<span class="danger">Not enough Alloys</span> ‚Äî need ${TIER2_PER_TIER3} Alloys to forge.`
            );
            updateForgeUI();
            return;
          }

          state.tier2resource -= TIER2_PER_TIER3;

          const baseBars = 1 * state.tier3Multiplier;
          let gained = baseBars;
          let crit = false;

          if (randomChance(CRIT_FORGE_CHANCE)) {
            crit = true;
            gained = baseBars * CRIT_FORGE_MULTIPLIER;
          }

          state.tier3resource += gained;
          state.totals.tier3Generated += gained;

          if (crit) {
            flashPill(pillBar);
            appendLog(
              `<span class="crit">Critical forge!</span> ${TIER2_PER_TIER3} Alloys ‚Üí <span class="success">${gained.toFixed(
                1
              )} Chrono Bars</span>.`
            );
          } else {
            appendLog(
              `Forge action: <span class="highlight">${TIER2_PER_TIER3}</span> Alloys ‚Üí <span class="success">${gained.toFixed(
                1
              )} Chrono Bars</span>.`
            );
          }

          checkMilestones();
          updateUI();
          saveState();
        }

        function forgeEpochCore() {
          if (state.tier3resource < TIER3_PER_TIER4) {
            appendLog(
              `<span class="danger">Not enough Chrono Bars</span> ‚Äî need ${TIER3_PER_TIER4} Bars to cast an Epoch Core.`
            );
            updateEpochUI();
            return;
          }

          state.tier3resource -= TIER3_PER_TIER4;
          state.tier4resource += 1;
          state.totals.tier4Generated += 1;

          flashPill(pillEpoch);
          appendLog(
            `Epoch Crucible: <span class="highlight">${TIER3_PER_TIER4}</span> Chrono Bars ‚Üí <span class="success">1 Epoch Core</span>.`
          );

          checkMilestones();
          updateUI();
          saveState();
        }

        function activateTimeSurge() {
          const surge = state.boosts.timeSurge;
          if (surge.active || surge.cooldown > 0) return;

          surge.active = true;
          surge.remaining = SURGE_DURATION;
          surge.cooldown = 0;

          appendLog(
            `<span class="highlight">Time Surge activated.</span> Ore flow increased by <span class="success">+300%</span> for ${SURGE_DURATION} seconds.`
          );
          updateTimeSurgeUI();
          saveState();
        }

        function toggleAutoSmelter() {
          const level = state.upgrades.tier2automation || 0;
          if (level <= 0) return;
          state.tier2AutomationEnabled = !state.tier2AutomationEnabled;
          appendLog(
            `Auto Smelter ${
              state.tier2AutomationEnabled
                ? '<span class="success">enabled</span>.'
                : '<span class="danger">disabled</span>.'
            }`
          );
          updateUpgradesUI();
          saveState();
        }

        function purchaseUpgrade(id) {
          const def = upgradeDefs[id];
          const level = state.upgrades[id] || 0;
          const cost = Math.round(
            def.baseCost * Math.pow(def.costScale, level)
          );

          if (def.currency === "tier1") {
            if (state.tier1resource < cost) return;
            state.tier1resource -= cost;
          }
          if (def.currency === "tier2") {
            if (state.tier2resource < cost) return;
            state.tier2resource -= cost;
            if (state.tier2resource < 0) state.tier2resource = 0;
          }

          state.upgrades[id] = level + 1;

          if (id === "tier1generation") {
            state.tier1BonusRate += def.bonusPerLevel;
            appendLog(
              `Upgrade: <span class="success">Faster Drilling</span> ‚Üí Ore rate boosted by <span class="highlight">${def.bonusPerLevel.toFixed(
                2
              )}/s</span>.`
            );
          } else if (id === "tier2automation") {
            state.tier2AutomationRate += def.bonusPerLevel;
            if (
              state.upgrades.tier2automation === 1 &&
              state.tier2AutomationRate > 0
            ) {
              state.tier2AutomationEnabled = true;
              appendLog(
                `Upgrade: <span class="success">Auto Smelter</span> unlocked and <span class="highlight">enabled</span>. It now auto-smelts Ore into Alloys.`
              );
            } else {
              appendLog(
                `Upgrade: <span class="success">Auto Smelter</span> ‚Üí Auto smelt boosted by <span class="highlight">${def.bonusPerLevel.toFixed(
                  2
                )} Alloys/s</span>.`
              );
            }
          } else if (id === "tier3efficiency") {
            state.tier3Multiplier += def.bonusPerLevel;
            appendLog(
              `Upgrade: <span class="success">Efficient Forge</span> ‚Üí Forge multiplier increased by <span class="highlight">${def.bonusPerLevel.toFixed(
                1
              )}x</span>.`
            );
          }

          updateUI();
          saveState();
        }

        // Events
        btnSmelt.addEventListener("click", smeltOre);
        btnForge.addEventListener("click", forgeBars);
        btnEpoch.addEventListener("click", forgeEpochCore);
        btnTimeSurge.addEventListener("click", activateTimeSurge);
        btnToggleAuto.addEventListener("click", toggleAutoSmelter);

        document.addEventListener("keydown", (e) => {
          // Don't hijack typing into inputs/textareas
          if (e.target.tagName === "INPUT" || e.target.tagName === "TEXTAREA")
            return;

          const key = e.key.toLowerCase();
          const code = e.code; // handles numpad vs top-row

          // =========================
          // DEV CHEATS (DEV_MODE only)
          // =========================
          if (DEV_MODE) {
            let cheated = false;

            // Treat top row and numpad the same
            const is1 = key === "1" || code === "Digit1" || code === "Numpad1";
            const is2 = key === "2" || code === "Digit2" || code === "Numpad2";
            const is3 = key === "3" || code === "Digit3" || code === "Numpad3";
            const is4 = key === "4" || code === "Digit4" || code === "Numpad4";

            if (is1) {
              // +1,000 Time Ore
              state.tier1resource += 1000;
              state.totals.tier1Generated += 1000;
              appendLog(
                `<span class="success">DEV:</span> Added <span class="highlight">1,000</span> Time Ore.`
              );
              flashPill(pillOre);
              cheated = true;
            } else if (is2) {
              // +100 Alloys
              state.tier2resource += 100;
              state.totals.tier2Generated += 100;
              appendLog(
                `<span class="success">DEV:</span> Added <span class="highlight">100</span> Alloys.`
              );
              flashPill(pillAlloy);
              cheated = true;
            } else if (is3) {
              // +10 Chrono Bars
              state.tier3resource += 10;
              state.totals.tier3Generated += 10;
              appendLog(
                `<span class="success">DEV:</span> Added <span class="highlight">10</span> Chrono Bars.`
              );
              flashPill(pillBar);
              cheated = true;
            } else if (is4) {
              // +1 Epoch Core
              state.tier4resource += 1;
              state.totals.tier4Generated += 1;
              appendLog(
                `<span class="success">DEV:</span> Added <span class="highlight">1</span> Epoch Core.`
              );
              flashPill(pillEpoch);
              cheated = true;
            } else if (key === "b") {
              // Toggle Time Surge on/off, ignoring cooldown
              const surge = state.boosts.timeSurge;
              if (!surge.active) {
                surge.active = true;
                surge.remaining = SURGE_DURATION;
                surge.cooldown = 0;
                appendLog(
                  `<span class="highlight">DEV:</span> Time Surge <span class="success">forced ON</span>.`
                );
              } else {
                surge.active = false;
                surge.remaining = 0;
                surge.cooldown = 0;
                appendLog(
                  `<span class="highlight">DEV:</span> Time Surge <span class="danger">forced OFF</span>.`
                );
              }
              cheated = true;
            }

            if (cheated) {
              e.preventDefault();
              checkMilestones();
              updateUI();
              saveState();
              return; // don't also trigger normal hotkeys
            }
          }

          // =========================
          // Normal gameplay hotkeys
          // =========================
          if (key === "s") {
            e.preventDefault();
            smeltOre();
          } else if (key === "f") {
            e.preventDefault();
            forgeBars();
          }
        });

        upgradesListEl.addEventListener("click", (e) => {
          const btn = e.target.closest("[data-upgrade-button]");
          if (!btn) return;
          const upgradeEl = btn.closest(".upgrade");
          if (!upgradeEl) return;
          const id = upgradeEl.getAttribute("data-upgrade-id");
          purchaseUpgrade(id);
        });

        resetBtn.addEventListener("click", () => {
          if (
            confirm(
              "Reset Temporal Forge? This clears all resources, milestones, and upgrades."
            )
          ) {
            resetState();
          }
        });

        window.addEventListener("beforeunload", saveState);

        // Init
        loadState();
        updateUI();
        computeDayRail();
        saveStatusEl.innerHTML = "Save: <span>Ready</span>";
        requestAnimationFrame(gameLoop);
      })();
    </script>
  </body>
</html>
