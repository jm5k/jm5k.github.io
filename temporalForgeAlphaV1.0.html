<!DOCTYPE html>
<html lang="en" data-theme="technolust">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0" />

    <title>Temporal Forge | Linear Clock Lab</title>
    <meta
      name="description"
      content="Temporal Forge ‚Äî an idle time-smelting game for Linear Clock Lab. Turn real-world seconds into Time Ore, Alloys, Chrono Bars, and Epoch Cores with upgrades, crits, milestones, and time boosts."
    />
    <meta
      name="keywords"
      content="idle game, incremental game, temporal forge, time smelter, linear clock lab, jm5k"
    />
    <meta name="author" content="jm5k" />
    <meta name="robots" content="index, follow" />

    <style>
      :root {
        --bg: #000;
        --fg: #e0e0e0;
        --muted: #9aa0aa;
        --accent: #00ffff;
        --accent-soft: rgba(0, 255, 255, 0.15);
        --rail: #111;
        --rail-border: #333;
        --card: #05060a;
        --card-border: #222;
        --danger: #ff4f4f;
        --success: #7bff7b;
        --shadow-soft: 0 0 30px rgba(0, 255, 255, 0.15);
        --radius-lg: 14px;
        --radius-sm: 8px;
        --transition-fast: 0.15s ease-out;
        --font-main: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
          sans-serif;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        padding: 0;
        min-height: 100vh;
        background: radial-gradient(
          circle at top,
          #050815 0,
          #000 40%,
          #000 100%
        );
        color: var(--fg);
        font-family: var(--font-main);
        display: flex;
        flex-direction: column;
      }

      a {
        color: var(--accent);
        text-decoration: none;
      }

      a:hover {
        text-decoration: underline;
      }

      header {
        padding: 16px 6vw 8px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
      }

      header .title-block {
        display: flex;
        flex-direction: column;
        gap: 2px;
      }

      header h1 {
        font-size: 1.4rem;
        letter-spacing: 0.06em;
        text-transform: uppercase;
        margin: 0;
      }

      header p {
        margin: 0;
        font-size: 0.85rem;
        color: var(--muted);
      }

      .nav-link {
        font-size: 0.8rem;
        padding: 6px 10px;
        border-radius: 999px;
        border: 1px solid var(--accent);
        background: rgba(0, 0, 0, 0.6);
        display: inline-flex;
        align-items: center;
        gap: 6px;
        text-decoration: none;
        box-shadow: 0 0 12px rgba(0, 255, 255, 0.2);
      }

      .nav-link span {
        font-size: 0.9rem;
      }

      main {
        padding: 0 6vw 24px;
        max-width: 1200px;
        width: 100%;
        margin: 0 auto 16px;
      }

      /* 24-hour rail */
      .day-rail {
        margin: 4px 0 20px;
        padding: 10px 0 12px;
      }

      .rail-label {
        display: flex;
        justify-content: space-between;
        font-size: 0.75rem;
        color: var(--muted);
        margin-bottom: 6px;
      }

      .rail-track {
        position: relative;
        height: 12px;
        border-radius: 999px;
        background: var(--rail);
        border: 1px solid var(--rail-border);
        overflow: hidden;
        box-shadow: var(--shadow-soft);
      }

      .rail-fill {
        position: absolute;
        inset: 0;
        background: linear-gradient(
          90deg,
          rgba(0, 255, 255, 0.2),
          rgba(0, 255, 255, 0.9),
          rgba(0, 255, 255, 0.2)
        );
        transform-origin: left center;
        transform: scaleX(0);
        transition: transform 0.4s ease-out;
      }

      .rail-marker {
        position: absolute;
        top: 50%;
        width: 3px;
        height: 22px;
        background: var(--accent);
        box-shadow: 0 0 10px rgba(0, 255, 255, 0.9);
        transform: translate(-50%, -50%);
      }

      .rail-meta {
        margin-top: 4px;
        display: flex;
        justify-content: space-between;
        font-size: 0.75rem;
        color: var(--muted);
      }

      /* Layout */
      .grid {
        display: grid;
        grid-template-columns: minmax(0, 1.2fr) minmax(0, 1fr);
        gap: 18px;
      }

      @media (max-width: 900px) {
        .grid {
          grid-template-columns: minmax(0, 1fr);
        }
      }

      .card {
        background: linear-gradient(
          145deg,
          #05060a 0,
          #050816 60%,
          #05060a 100%
        );
        border-radius: var(--radius-lg);
        padding: 14px 16px 16px;
        border: 1px solid var(--card-border);
        box-shadow: 0 0 18px rgba(0, 0, 0, 0.7);
      }

      .card h2 {
        font-size: 1rem;
        text-transform: uppercase;
        letter-spacing: 0.14em;
        color: var(--muted);
        margin: 0 0 10px;
      }

      .card small {
        font-size: 0.75rem;
        color: var(--muted);
      }

      .resources {
        display: grid;
        grid-template-columns: repeat(4, minmax(0, 1fr));
        gap: 8px;
        margin: 10px 0 12px;
      }

      @media (max-width: 800px) {
        .resources {
          grid-template-columns: repeat(2, minmax(0, 1fr));
        }
      }

      .res-pill {
        border-radius: var(--radius-sm);
        border: 1px solid var(--card-border);
        padding: 8px 9px;
        background: radial-gradient(circle at top left, #0a1018, #05060a);
        display: flex;
        flex-direction: column;
        gap: 3px;
        position: relative;
      }

      .res-pill.celebrate {
        box-shadow: 0 0 18px rgba(0, 255, 255, 0.7);
        border-color: rgba(0, 255, 255, 0.9);
      }

      .res-label {
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 0.75rem;
        color: var(--muted);
      }

      .res-label span.key {
        text-transform: uppercase;
        letter-spacing: 0.12em;
      }

      .res-label span.badge {
        padding: 2px 6px;
        border-radius: 999px;
        border: 1px solid rgba(0, 255, 255, 0.4);
        color: var(--accent);
        font-size: 0.7rem;
      }

      .res-value {
        font-size: 1.05rem;
        font-variant-numeric: tabular-nums;
      }

      .res-value strong {
        color: var(--accent);
      }

      .res-rate {
        font-size: 0.7rem;
        color: var(--muted);
      }

      .actions-block {
        margin-top: 4px;
        border-top: 1px dashed rgba(120, 130, 140, 0.5);
        padding-top: 8px;
        display: grid;
        grid-template-columns: minmax(0, 1fr);
        gap: 8px;
      }

      .action-row {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        align-items: center;
      }

      .action-label {
        font-size: 0.75rem;
        color: var(--muted);
      }

      button {
        cursor: pointer;
        border-radius: 999px;
        border: 1px solid var(--card-border);
        background: rgba(0, 0, 0, 0.6);
        color: var(--fg);
        padding: 6px 11px;
        font-size: 0.8rem;
        font-family: inherit;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        transition: background var(--transition-fast),
          border-color var(--transition-fast), transform var(--transition-fast),
          box-shadow var(--transition-fast), opacity var(--transition-fast);
        white-space: nowrap;
      }

      button span.hotkey {
        opacity: 0.7;
        font-size: 0.7rem;
      }

      button.primary {
        border-color: rgba(0, 255, 255, 0.8);
        box-shadow: 0 0 14px rgba(0, 255, 255, 0.25);
      }

      button.primary:hover:not(:disabled) {
        background: linear-gradient(90deg, #041f24, #062a32);
        transform: translateY(-1px);
      }

      button.secondary:hover:not(:disabled) {
        background: rgba(255, 255, 255, 0.06);
        transform: translateY(-1px);
      }

      button:disabled {
        opacity: 0.4;
        cursor: default;
        box-shadow: none;
      }

      .forge-meta,
      .epoch-meta,
      .boost-meta,
      .auto-meta {
        font-size: 0.72rem;
        color: var(--muted);
      }

      .forge-meta span.ready,
      .epoch-meta span.ready {
        color: var(--success);
      }

      .boost-meta span.status {
        color: var(--accent);
      }

      .smelt-log {
        margin-top: 8px;
        padding-top: 6px;
        border-top: 1px dashed rgba(120, 130, 140, 0.5);
        font-size: 0.72rem;
        color: var(--muted);
        max-height: 96px;
        overflow: hidden;
      }

      .smelt-log-line {
        opacity: 0.85;
      }

      .smelt-log-line + .smelt-log-line {
        margin-top: 2px;
      }

      .smelt-log-line span.highlight {
        color: var(--accent);
      }

      .smelt-log-line span.success {
        color: var(--success);
      }

      .smelt-log-line span.danger {
        color: var(--danger);
      }

      .smelt-log-line span.crit {
        color: #ffd966;
      }

      /* Upgrades */
      .upgrades-list {
        display: flex;
        flex-direction: column;
        gap: 6px;
        margin-top: 6px;
      }

      .upgrade {
        border-radius: var(--radius-sm);
        border: 1px solid var(--card-border);
        padding: 7px 9px;
        display: grid;
        grid-template-columns: minmax(0, 1.4fr) auto;
        gap: 6px;
        background: radial-gradient(circle at top left, #070b10, #05060a);
      }

      .upgrade-header {
        font-size: 0.82rem;
        display: flex;
        flex-direction: column;
        gap: 2px;
      }

      .upgrade-header strong {
        letter-spacing: 0.06em;
        text-transform: uppercase;
        font-size: 0.76rem;
        color: var(--accent);
      }

      .upgrade-header span.desc {
        color: var(--muted);
        font-size: 0.75rem;
      }

      .upgrade-meta {
        font-size: 0.7rem;
        color: var(--muted);
      }

      .upgrade-meta span.cost {
        color: var(--accent);
      }

      .upgrade-meta span.level {
        color: var(--success);
      }

      .upgrade-actions {
        display: flex;
        align-items: center;
        justify-content: flex-end;
      }

      /* Footer */
      footer {
        padding: 10px 6vw 14px;
        border-top: 1px solid #111;
        font-size: 0.75rem;
        color: var(--muted);
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 8px;
      }

      .save-status {
        font-size: 0.72rem;
        opacity: 0.8;
      }

      .save-status span {
        color: var(--accent);
      }

      .danger-link {
        color: var(--danger);
        cursor: pointer;
        text-decoration: underline;
      }

      @media (max-width: 600px) {
        header {
          flex-direction: column;
          align-items: flex-start;
        }

        footer {
          flex-direction: column;
          align-items: flex-start;
        }
      }
    </style>
  </head>
  <body>
    <header>
      <div class="title-block">
        <h1>Temporal Forge</h1>
        <p>
          Smelt real-world seconds into alloys, Chrono Bars, and Epoch Cores ‚Äî
          with crits, milestones, and time boosts.
        </p>
      </div>
      <a class="nav-link" href="index.html">
        <span>‚Üê</span>
        <span>Back to Linear Clock Lab</span>
      </a>
    </header>

    <main>
      <!-- Day Rail -->
      <section class="day-rail">
        <div class="rail-label">
          <span>24-Hour Continuum</span>
          <span id="rail-time-label">--:--:--</span>
        </div>
        <div class="rail-track">
          <div class="rail-fill" id="rail-fill"></div>
          <div class="rail-marker" id="rail-marker" style="left: 0%"></div>
        </div>
        <div class="rail-meta">
          <span id="rail-day-percent">Day progress: --%</span>
          <span id="rail-remaining">Remaining: --:--:--</span>
        </div>
      </section>

      <section class="grid">
        <!-- LEFT: Resources & Actions -->
        <section class="card">
          <h2>Smelter Core</h2>
          <small
            >Time flows even when this tab is in the background. Your forge
            catches up when you return.</small
          >

          <div class="resources">
            <div class="res-pill" id="pill-ore">
              <div class="res-label">
                <span class="key">Time Ore</span>
                <span class="badge">Base Resource</span>
              </div>
              <div class="res-value">
                <strong id="ore-count">0</strong>
              </div>
              <div class="res-rate">
                Generation: <span id="ore-rate">0 /s</span>
              </div>
            </div>

            <div class="res-pill" id="pill-alloy">
              <div class="res-label">
                <span class="key">Alloys</span>
                <span class="badge">Refined</span>
              </div>
              <div class="res-value">
                <strong id="alloy-count">0</strong>
              </div>
              <div class="res-rate">
                Auto Smelt: <span id="alloy-rate">0 /s</span>
              </div>
            </div>

            <div class="res-pill" id="pill-bar">
              <div class="res-label">
                <span class="key">Chrono Bars</span>
                <span class="badge">Tier III</span>
              </div>
              <div class="res-value">
                <strong id="bar-count">0</strong>
              </div>
              <div class="res-rate">
                Forge Power: <span id="bar-mult">x1.0</span>
              </div>
            </div>

            <div class="res-pill" id="pill-epoch">
              <div class="res-label">
                <span class="key">Epoch Cores</span>
                <span class="badge">Tier IV</span>
              </div>
              <div class="res-value">
                <strong id="epoch-count">0</strong>
              </div>
              <div class="res-rate">Formed from Chrono Bars.</div>
            </div>
          </div>

          <div class="actions-block">
            <!-- Smelting -->
            <div class="action-row">
              <div class="action-label">Smelting</div>
              <button
                id="btn-smelt"
                class="secondary"
                title="Convert 60 Time Ore into 1 Alloy. Hotkey: S"
              >
                üî• Smelt 60 Ore ‚Üí 1 Alloy <span class="hotkey">(S)</span>
              </button>
            </div>

            <!-- Forge Bars -->
            <div class="action-row">
              <div class="action-label">Forge Station</div>
              <button
                id="btn-forge"
                class="primary"
                title="Forge Chrono Bars by spending Alloys. Hotkey: F"
              >
                üî® Forge Chrono Bars (60 Alloys) <span class="hotkey">(F)</span>
              </button>
            </div>

            <div class="forge-meta">
              Ready for forge:
              <span class="ready" id="forge-ready-count">0</span>
              possible use(s) right now.
            </div>

            <!-- Forge Epoch Cores -->
            <div class="action-row">
              <div class="action-label">Epoch Crucible</div>
              <button
                id="btn-epoch"
                class="primary"
                title="Cast an Epoch Core from Chrono Bars."
              >
                ‚ú® Cast Epoch Core (12 Chrono Bars)
              </button>
            </div>
            <div class="epoch-meta">
              Ready for cast:
              <span class="ready" id="epoch-ready-count">0</span>
              possible core(s) right now.
            </div>

            <!-- Auto Smelter Toggle -->
            <div class="action-row">
              <div class="action-label">Automation</div>
              <button
                id="btn-toggle-auto"
                class="secondary"
                title="Toggle automatic smelting of Ore into Alloys. Unlocks with Auto Smelter upgrade."
              >
                Auto Smelter: Locked
              </button>
            </div>
            <div class="auto-meta">
              Auto Smelter converts <span class="highlight">Time Ore</span> into
              <span class="highlight">Alloys</span> when enabled. Turn it off if
              you want to stockpile Ore for upgrades.
            </div>

            <!-- Time Boosts -->
            <div class="action-row">
              <div class="action-label">Temporal Boosts</div>
              <button
                id="btn-time-surge"
                class="secondary"
                title="Temporarily triples Time Ore generation."
              >
                ‚ö° Time Surge (+300% Ore/sec, 20s)
              </button>
            </div>
            <div class="boost-meta">
              Surge status:
              <span class="status" id="time-surge-status">Ready</span>
            </div>
          </div>

          <div class="smelt-log" id="log">
            <div class="smelt-log-line">
              Forge initialized. <span class="highlight">Time Ore</span> will
              accumulate as long as this save exists.
            </div>
          </div>
        </section>

        <!-- RIGHT: Upgrades -->
        <section class="card">
          <h2>Upgrades</h2>
          <small
            >Crits, milestones, and automation push your forge forward.</small
          >

          <div class="upgrades-list" id="upgrades-list">
            <article class="upgrade" data-upgrade-id="hotterFurnace">
              <div>
                <div class="upgrade-header">
                  <strong>Hotter Furnace</strong>
                  <span class="desc"
                    >Boosts Time Ore generation per second.</span
                  >
                </div>
                <div class="upgrade-meta">
                  Cost: <span class="cost" data-cost-label>120 Time Ore</span> ¬∑
                  Level: <span class="level" data-level-label>0</span>
                </div>
              </div>
              <div class="upgrade-actions">
                <button class="primary" data-upgrade-button>Upgrade</button>
              </div>
            </article>

            <article class="upgrade" data-upgrade-id="autoSmelter">
              <div>
                <div class="upgrade-header">
                  <strong>Auto Smelter</strong>
                  <span class="desc"
                    >Automatically smelts Ore into Alloys over time.</span
                  >
                </div>
                <div class="upgrade-meta">
                  Cost: <span class="cost" data-cost-label>5 Alloys</span> ¬∑
                  Level: <span class="level" data-level-label>0</span>
                </div>
              </div>
              <div class="upgrade-actions">
                <button class="secondary" data-upgrade-button>Upgrade</button>
              </div>
            </article>

            <article class="upgrade" data-upgrade-id="efficientForge">
              <div>
                <div class="upgrade-header">
                  <strong>Efficient Forge</strong>
                  <span class="desc"
                    >Each forge action creates more Chrono Bars.</span
                  >
                </div>
                <div class="upgrade-meta">
                  Cost: <span class="cost" data-cost-label>10 Alloys</span> ¬∑
                  Level: <span class="level" data-level-label>0</span>
                </div>
              </div>
              <div class="upgrade-actions">
                <button class="secondary" data-upgrade-button>Upgrade</button>
              </div>
            </article>
          </div>
        </section>
      </section>
    </main>

    <footer>
      <div class="save-status" id="save-status">Save: <span>Ready</span></div>
      <div>
        <span
          >¬© jm5k 2025 ‚Äî Temporal Forge, a Linear Clock Lab experiment.</span
        >
        &nbsp;¬∑&nbsp;
        <span class="danger-link" id="reset-save">Reset Forge</span>
      </div>
    </footer>

    <script>
      (function () {
        const SAVE_KEY = "TemporalForgeSave_v2";

        const oreEl = document.getElementById("ore-count");
        const alloyEl = document.getElementById("alloy-count");
        const barEl = document.getElementById("bar-count");
        const epochEl = document.getElementById("epoch-count");
        const oreRateEl = document.getElementById("ore-rate");
        const alloyRateEl = document.getElementById("alloy-rate");
        const barMultEl = document.getElementById("bar-mult");
        const logEl = document.getElementById("log");
        const saveStatusEl = document.getElementById("save-status");

        const btnSmelt = document.getElementById("btn-smelt");
        const btnForge = document.getElementById("btn-forge");
        const btnEpoch = document.getElementById("btn-epoch");
        const btnTimeSurge = document.getElementById("btn-time-surge");
        const btnToggleAuto = document.getElementById("btn-toggle-auto");

        const forgeReadyEl = document.getElementById("forge-ready-count");
        const epochReadyEl = document.getElementById("epoch-ready-count");
        const timeSurgeStatusEl = document.getElementById("time-surge-status");

        const resetBtn = document.getElementById("reset-save");

        const railFill = document.getElementById("rail-fill");
        const railMarker = document.getElementById("rail-marker");
        const railTimeLabel = document.getElementById("rail-time-label");
        const railDayPercent = document.getElementById("rail-day-percent");
        const railRemaining = document.getElementById("rail-remaining");

        const upgradesListEl = document.getElementById("upgrades-list");

        const pillOre = document.getElementById("pill-ore");
        const pillAlloy = document.getElementById("pill-alloy");
        const pillBar = document.getElementById("pill-bar");
        const pillEpoch = document.getElementById("pill-epoch");

        // Economy constants
        const ORE_PER_ALLOY = 60;
        const ALLOYS_PER_BAR = 60;
        const BARS_PER_EPOCH = 12;

        // Crit chances
        const CRIT_SMELT_CHANCE = 0.05; // 5%
        const CRIT_FORGE_CHANCE = 0.05; // 5%
        const CRIT_SMELT_MULTIPLIER = 3;
        const CRIT_FORGE_MULTIPLIER = 3;

        // Time Surge
        const SURGE_MULTIPLIER = 3;
        const SURGE_DURATION = 20; // seconds
        const SURGE_COOLDOWN = 300; // seconds (5 minutes)

        let state = {
          ore: 0,
          alloys: 0,
          bars: 0,
          epochs: 0,
          orePerSecondBase: 1,
          orePerSecondBonus: 0,
          autoSmeltRate: 0,
          autoSmelterEnabled: false,
          forgeMultiplier: 1,
          upgrades: {
            hotterFurnace: 0,
            autoSmelter: 0,
            efficientForge: 0,
          },
          // Totals for milestones
          totals: {
            oreGenerated: 0,
            alloysSmelted: 0,
            barsForged: 0,
            epochsCast: 0,
          },
          // Milestone flags (true = already granted)
          milestones: {
            ore10k: false,
            ore100k: false,
            ore1m: false,
            alloys100: false,
            alloys500: false,
            alloys2k: false,
            bars10: false,
            bars50: false,
            bars200: false,
            epochs1: false,
            epochs3: false,
            epochs10: false,
          },
          // Time Surge boost
          boosts: {
            timeSurge: {
              active: false,
              remaining: 0,
              cooldown: 0,
            },
          },
          lastUpdate: Date.now(),
        };

        const upgradeDefs = {
          hotterFurnace: {
            baseCost: 120,
            costScale: 1.65,
            currency: "ore",
            bonusPerLevel: 0.4,
            label: "Time Ore",
          },
          autoSmelter: {
            baseCost: 5,
            costScale: 2,
            currency: "alloys",
            bonusPerLevel: 0.2,
            label: "Alloys",
          },
          efficientForge: {
            baseCost: 10,
            costScale: 2.1,
            currency: "alloys",
            bonusPerLevel: 0.3,
            label: "Alloys",
          },
        };

        function formatNumber(value) {
          if (value < 1000) return value.toFixed(0);
          if (value < 1000000)
            return value.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",");
          return value.toExponential(2);
        }

        function formatTime(h, m, s) {
          const pad = (n) => String(n).padStart(2, "0");
          return pad(h) + ":" + pad(m) + ":" + pad(s);
        }

        function randomChance(p) {
          return Math.random() < p;
        }

        function flashPill(el) {
          el.classList.add("celebrate");
          setTimeout(() => el.classList.remove("celebrate"), 350);
        }

        function appendLog(messageHtml) {
          const line = document.createElement("div");
          line.className = "smelt-log-line";
          line.innerHTML = messageHtml;
          logEl.insertBefore(line, logEl.firstChild);
          while (logEl.children.length > 6) {
            logEl.removeChild(logEl.lastChild);
          }
        }

        function saveState() {
          try {
            const data = { ...state, lastUpdate: Date.now() };
            localStorage.setItem(SAVE_KEY, JSON.stringify(data));
            saveStatusEl.innerHTML = "Save: <span>OK</span>";
          } catch (e) {
            console.error("Save error", e);
            saveStatusEl.innerHTML =
              'Save: <span style="color:#ff4f4f">Error</span>';
          }
        }

        function loadState() {
          try {
            const raw = localStorage.getItem(SAVE_KEY);
            if (!raw) {
              state.lastUpdate = Date.now();
              return;
            }
            const data = JSON.parse(raw);
            state = {
              ...state,
              ...data,
              upgrades: { ...state.upgrades, ...(data.upgrades || {}) },
              totals: { ...state.totals, ...(data.totals || {}) },
              milestones: { ...state.milestones, ...(data.milestones || {}) },
              boosts: {
                ...state.boosts,
                ...(data.boosts || {}),
              },
            };
            // Backwards-compat: if autoSmelterEnabled missing but we have Auto Smelter, default to true
            if (data.autoSmelterEnabled === undefined) {
              state.autoSmelterEnabled = (state.upgrades.autoSmelter || 0) > 0;
            }
            appendLog(
              `<span class="success">Loaded existing forge state.</span> You kept earning <span class="highlight">Time Ore</span> since your last visit.`
            );
          } catch (e) {
            console.error("Load error", e);
            appendLog(
              `<span class="danger">Save data corrupted.</span> A fresh forge has been initialized.`
            );
          } finally {
            state.lastUpdate = Date.now();
          }
        }

        function resetState() {
          localStorage.removeItem(SAVE_KEY);
          state = {
            ore: 0,
            alloys: 0,
            bars: 0,
            epochs: 0,
            orePerSecondBase: 1,
            orePerSecondBonus: 0,
            autoSmeltRate: 0,
            autoSmelterEnabled: false,
            forgeMultiplier: 1,
            upgrades: {
              hotterFurnace: 0,
              autoSmelter: 0,
              efficientForge: 0,
            },
            totals: {
              oreGenerated: 0,
              alloysSmelted: 0,
              barsForged: 0,
              epochsCast: 0,
            },
            milestones: {
              ore10k: false,
              ore100k: false,
              ore1m: false,
              alloys100: false,
              alloys500: false,
              alloys2k: false,
              bars10: false,
              bars50: false,
              bars200: false,
              epochs1: false,
              epochs3: false,
              epochs10: false,
            },
            boosts: {
              timeSurge: {
                active: false,
                remaining: 0,
                cooldown: 0,
              },
            },
            lastUpdate: Date.now(),
          };
          appendLog(
            `<span class="danger">Forge reset.</span> All resources, milestones, and upgrades cleared.`
          );
          updateUI();
          saveState();
        }

        function computeDayRail() {
          const now = new Date();
          const h = now.getHours();
          const m = now.getMinutes();
          const s = now.getSeconds();

          const secondsToday = h * 3600 + m * 60 + s;
          const total = 24 * 3600;
          const ratio = secondsToday / total;
          const percent = ratio * 100;

          railFill.style.transform = `scaleX(${ratio})`;
          railMarker.style.left = `${percent}%`;

          railTimeLabel.textContent = formatTime(h, m, s);
          railDayPercent.textContent =
            "Day progress: " + percent.toFixed(1) + "%";

          const remaining = total - secondsToday;
          const rh = Math.floor(remaining / 3600);
          const rm = Math.floor((remaining % 3600) / 60);
          const rs = remaining % 60;

          railRemaining.textContent = "Remaining: " + formatTime(rh, rm, rs);
        }

        function checkMilestones() {
          const t = state.totals;
          const m = state.milestones;

          // Ore milestones
          if (!m.ore10k && t.oreGenerated >= 10000) {
            m.ore10k = true;
            state.orePerSecondBonus += 0.5;
            flashPill(pillOre);
            appendLog(
              `<span class="success">Milestone unlocked:</span> Smelted 10,000 Time Ore. Permanent Ore rate +<span class="highlight">0.5/s</span>.`
            );
          }
          if (!m.ore100k && t.oreGenerated >= 100000) {
            m.ore100k = true;
            state.orePerSecondBonus += 1.0;
            flashPill(pillOre);
            appendLog(
              `<span class="success">Milestone unlocked:</span> Smelted 100,000 Time Ore. Permanent Ore rate +<span class="highlight">1.0/s</span>.`
            );
          }
          if (!m.ore1m && t.oreGenerated >= 1000000) {
            m.ore1m = true;
            state.orePerSecondBonus += 2.0;
            flashPill(pillOre);
            appendLog(
              `<span class="success">Milestone unlocked:</span> Smelted 1,000,000 Time Ore. Permanent Ore rate +<span class="highlight">2.0/s</span>.`
            );
          }

          // Alloy milestones
          if (!m.alloys100 && t.alloysSmelted >= 100) {
            m.alloys100 = true;
            state.autoSmeltRate += 0.1;
            flashPill(pillAlloy);
            appendLog(
              `<span class="success">Milestone unlocked:</span> Smelted 100 Alloys. Auto Smelt +<span class="highlight">0.10/s</span>.`
            );
          }
          if (!m.alloys500 && t.alloysSmelted >= 500) {
            m.alloys500 = true;
            state.autoSmeltRate += 0.2;
            flashPill(pillAlloy);
            appendLog(
              `<span class="success">Milestone unlocked:</span> Smelted 500 Alloys. Auto Smelt +<span class="highlight">0.20/s</span>.`
            );
          }
          if (!m.alloys2k && t.alloysSmelted >= 2000) {
            m.alloys2k = true;
            state.autoSmeltRate += 0.4;
            flashPill(pillAlloy);
            appendLog(
              `<span class="success">Milestone unlocked:</span> Smelted 2,000 Alloys. Auto Smelt +<span class="highlight">0.40/s</span>.`
            );
          }

          // Bar milestones
          if (!m.bars10 && t.barsForged >= 10) {
            m.bars10 = true;
            state.forgeMultiplier += 0.3;
            flashPill(pillBar);
            appendLog(
              `<span class="success">Milestone unlocked:</span> Forged 10 Chrono Bars. Forge multiplier +<span class="highlight">0.3x</span>.`
            );
          }
          if (!m.bars50 && t.barsForged >= 50) {
            m.bars50 = true;
            state.forgeMultiplier += 0.5;
            flashPill(pillBar);
            appendLog(
              `<span class="success">Milestone unlocked:</span> Forged 50 Chrono Bars. Forge multiplier +<span class="highlight">0.5x</span>.`
            );
          }
          if (!m.bars200 && t.barsForged >= 200) {
            m.bars200 = true;
            state.forgeMultiplier += 1.0;
            flashPill(pillBar);
            appendLog(
              `<span class="success">Milestone unlocked:</span> Forged 200 Chrono Bars. Forge multiplier +<span class="highlight">1.0x</span>.`
            );
          }

          // Epoch milestones
          if (!m.epochs1 && t.epochsCast >= 1) {
            m.epochs1 = true;
            state.orePerSecondBase += 0.5;
            flashPill(pillEpoch);
            appendLog(
              `<span class="success">Epoch Milestone:</span> 1 Epoch Core forged. Base Ore rate +<span class="highlight">0.5/s</span>.`
            );
          }
          if (!m.epochs3 && t.epochsCast >= 3) {
            m.epochs3 = true;
            state.orePerSecondBase += 1.0;
            state.autoSmeltRate += 0.2;
            flashPill(pillEpoch);
            appendLog(
              `<span class="success">Epoch Milestone:</span> 3 Epoch Cores forged. Base Ore rate +<span class="highlight">1.0/s</span>, Auto Smelt +<span class="highlight">0.2/s</span>.`
            );
          }
          if (!m.epochs10 && t.epochsCast >= 10) {
            m.epochs10 = true;
            state.forgeMultiplier += 1.5;
            flashPill(pillEpoch);
            appendLog(
              `<span class="success">Epoch Milestone:</span> 10 Epoch Cores forged. Forge multiplier +<span class="highlight">1.5x</span>.`
            );
          }
        }

        function updateAutoSmelterToggleUI() {
          const level = state.upgrades.autoSmelter || 0;
          if (level <= 0) {
            btnToggleAuto.disabled = true;
            btnToggleAuto.textContent = "Auto Smelter: Locked";
          } else {
            btnToggleAuto.disabled = false;
            btnToggleAuto.textContent = state.autoSmelterEnabled
              ? "Auto Smelter: ON"
              : "Auto Smelter: OFF";
          }
        }

        function updateUpgradesUI() {
          const upgradeEls = upgradesListEl.querySelectorAll(".upgrade");
          upgradeEls.forEach((el) => {
            const id = el.getAttribute("data-upgrade-id");
            const def = upgradeDefs[id];
            const level = state.upgrades[id] || 0;

            const cost = Math.round(
              def.baseCost * Math.pow(def.costScale, level)
            );

            const costLabel = el.querySelector("[data-cost-label]");
            const levelLabel = el.querySelector("[data-level-label]");
            const button = el.querySelector("[data-upgrade-button]");

            costLabel.textContent = `${cost} ${def.label}`;
            levelLabel.textContent = level;

            let affordable = false;
            if (def.currency === "ore") {
              affordable = state.ore >= cost;
            } else if (def.currency === "alloys") {
              affordable = state.alloys >= cost;
            }

            button.disabled = !affordable;
          });

          const orePerSec = state.orePerSecondBase + state.orePerSecondBonus;
          oreRateEl.textContent = orePerSec.toFixed(2) + " /s";

          const effectiveAutoRate = state.autoSmelterEnabled
            ? state.autoSmeltRate
            : 0;
          alloyRateEl.textContent = effectiveAutoRate.toFixed(2) + " /s";

          barMultEl.textContent = "x" + state.forgeMultiplier.toFixed(1);
          updateAutoSmelterToggleUI();
        }

        function updateForgeUI() {
          const possibleForges = Math.floor(state.alloys / ALLOYS_PER_BAR);
          forgeReadyEl.textContent = possibleForges;
          btnForge.disabled = possibleForges <= 0;
          btnForge.title = possibleForges
            ? `Forge Chrono Bars using ${ALLOYS_PER_BAR} Alloys. You can forge ${possibleForges} time(s) now. Hotkey: F`
            : `Not enough Alloys. Requires ${ALLOYS_PER_BAR} Alloys per Forge. Hotkey: F`;
        }

        function updateEpochUI() {
          const possibleEpochs = Math.floor(state.bars / BARS_PER_EPOCH);
          epochReadyEl.textContent = possibleEpochs;
          btnEpoch.disabled = possibleEpochs <= 0;
          btnEpoch.title = possibleEpochs
            ? `Cast an Epoch Core using ${BARS_PER_EPOCH} Chrono Bars. You can cast ${possibleEpochs} time(s) now.`
            : `Not enough Chrono Bars. Requires ${BARS_PER_EPOCH} Bars per Epoch Core.`;
        }

        function updateTimeSurgeUI() {
          const surge = state.boosts.timeSurge;
          if (surge.active) {
            timeSurgeStatusEl.textContent =
              "Active (" + Math.ceil(surge.remaining) + "s)";
            btnTimeSurge.disabled = true;
          } else if (surge.cooldown > 0) {
            timeSurgeStatusEl.textContent =
              "Cooldown (" + Math.ceil(surge.cooldown) + "s)";
            btnTimeSurge.disabled = true;
          } else {
            timeSurgeStatusEl.textContent = "Ready";
            btnTimeSurge.disabled = false;
          }
        }

        function updateUI() {
          oreEl.textContent = formatNumber(state.ore);
          alloyEl.textContent = formatNumber(state.alloys);
          barEl.textContent = formatNumber(state.bars);
          epochEl.textContent = formatNumber(state.epochs);
          updateUpgradesUI();
          updateForgeUI();
          updateEpochUI();
          updateTimeSurgeUI();
        }

        function updateBoostTimers(deltaSeconds) {
          const surge = state.boosts.timeSurge;
          if (surge.active) {
            surge.remaining -= deltaSeconds;
            if (surge.remaining <= 0) {
              surge.active = false;
              surge.remaining = 0;
              surge.cooldown = SURGE_COOLDOWN;
              appendLog(
                `<span class="highlight">Time Surge</span> has ended. Ore flow returns to normal.`
              );
            }
          } else if (surge.cooldown > 0) {
            surge.cooldown -= deltaSeconds;
            if (surge.cooldown < 0) surge.cooldown = 0;
          }
        }

        function processTick(deltaSeconds) {
          const surgeMult = state.boosts.timeSurge.active
            ? SURGE_MULTIPLIER
            : 1;

          const baseOrePerSec =
            state.orePerSecondBase + state.orePerSecondBonus;
          const orePerSec = baseOrePerSec * surgeMult;

          const oreGain = orePerSec * deltaSeconds;
          state.ore += oreGain;
          state.totals.oreGenerated += oreGain;

          const effectiveAutoRate = state.autoSmelterEnabled
            ? state.autoSmeltRate
            : 0;

          if (effectiveAutoRate > 0 && state.ore > 0) {
            const potentialAlloys = effectiveAutoRate * deltaSeconds;
            const maxByOre = state.ore / ORE_PER_ALLOY;
            const alloysProduced = Math.min(potentialAlloys, maxByOre);
            if (alloysProduced > 0) {
              state.ore -= alloysProduced * ORE_PER_ALLOY;
              state.alloys += alloysProduced;
              state.totals.alloysSmelted += alloysProduced;
            }
          }

          checkMilestones();
        }

        function gameLoop() {
          const now = Date.now();
          const deltaMs = now - state.lastUpdate;
          state.lastUpdate = now;

          const deltaSeconds = Math.max(0, deltaMs / 1000);
          if (deltaSeconds > 0) {
            processTick(deltaSeconds);
            updateBoostTimers(deltaSeconds);
            updateUI();
          }

          computeDayRail();
          requestAnimationFrame(gameLoop);
        }

        function smeltOre() {
          if (state.ore < ORE_PER_ALLOY) {
            appendLog(
              `<span class="danger">Not enough Ore</span> ‚Äî need ${ORE_PER_ALLOY} Time Ore to smelt.`
            );
            return;
          }

          state.ore -= ORE_PER_ALLOY;

          let gainedAlloys = 1;
          let crit = false;
          if (randomChance(CRIT_SMELT_CHANCE)) {
            crit = true;
            gainedAlloys = CRIT_SMELT_MULTIPLIER;
          }

          state.alloys += gainedAlloys;
          state.totals.alloysSmelted += gainedAlloys;

          if (crit) {
            flashPill(pillAlloy);
            appendLog(
              `<span class="crit">Critical smelt!</span> ${ORE_PER_ALLOY} Ore ‚Üí <span class="success">${gainedAlloys} Alloys</span>.`
            );
          } else {
            appendLog(
              `Manual smelt: <span class="highlight">${ORE_PER_ALLOY}</span> Ore ‚Üí <span class="success">${gainedAlloys} Alloy${
                gainedAlloys > 1 ? "s" : ""
              }</span>.`
            );
          }

          checkMilestones();
          updateUI();
          saveState();
        }

        function forgeBars() {
          if (state.alloys < ALLOYS_PER_BAR) {
            appendLog(
              `<span class="danger">Not enough Alloys</span> ‚Äî need ${ALLOYS_PER_BAR} Alloys to forge.`
            );
            updateForgeUI();
            return;
          }

          state.alloys -= ALLOYS_PER_BAR;

          const baseBars = 1 * state.forgeMultiplier;
          let barsGained = baseBars;
          let crit = false;

          if (randomChance(CRIT_FORGE_CHANCE)) {
            crit = true;
            barsGained = baseBars * CRIT_FORGE_MULTIPLIER;
          }

          state.bars += barsGained;
          state.totals.barsForged += barsGained;

          if (crit) {
            flashPill(pillBar);
            appendLog(
              `<span class="crit">Critical forge!</span> ${ALLOYS_PER_BAR} Alloys ‚Üí <span class="success">${barsGained.toFixed(
                1
              )} Chrono Bars</span>.`
            );
          } else {
            appendLog(
              `Forge action: <span class="highlight">${ALLOYS_PER_BAR}</span> Alloys ‚Üí <span class="success">${barsGained.toFixed(
                1
              )} Chrono Bars</span>.`
            );
          }

          checkMilestones();
          updateUI();
          saveState();
        }

        function forgeEpochCore() {
          if (state.bars < BARS_PER_EPOCH) {
            appendLog(
              `<span class="danger">Not enough Chrono Bars</span> ‚Äî need ${BARS_PER_EPOCH} Bars to cast an Epoch Core.`
            );
            updateEpochUI();
            return;
          }
          state.bars -= BARS_PER_EPOCH;
          state.epochs += 1;
          state.totals.epochsCast += 1;

          flashPill(pillEpoch);
          appendLog(
            `Epoch Crucible: <span class="highlight">${BARS_PER_EPOCH}</span> Chrono Bars ‚Üí <span class="success">1 Epoch Core</span>.`
          );

          checkMilestones();
          updateUI();
          saveState();
        }

        function activateTimeSurge() {
          const surge = state.boosts.timeSurge;
          if (surge.active || surge.cooldown > 0) return;

          surge.active = true;
          surge.remaining = SURGE_DURATION;
          surge.cooldown = 0;

          appendLog(
            `<span class="highlight">Time Surge activated.</span> Ore flow increased by <span class="success">+300%</span> for ${SURGE_DURATION} seconds.`
          );
          updateTimeSurgeUI();
          saveState();
        }

        function toggleAutoSmelter() {
          const level = state.upgrades.autoSmelter || 0;
          if (level <= 0) return; // still locked

          state.autoSmelterEnabled = !state.autoSmelterEnabled;
          appendLog(
            `Auto Smelter ${
              state.autoSmelterEnabled
                ? '<span class="success">enabled</span>.'
                : '<span class="danger">disabled</span>.'
            }`
          );
          updateUpgradesUI();
          saveState();
        }

        function purchaseUpgrade(id) {
          const def = upgradeDefs[id];
          const level = state.upgrades[id] || 0;
          const cost = Math.round(
            def.baseCost * Math.pow(def.costScale, level)
          );

          if (def.currency === "ore") {
            if (state.ore < cost) return;
            state.ore -= cost;
          } else if (def.currency === "alloys") {
            if (state.alloys < cost) return;
            state.alloys -= cost;
          }

          state.upgrades[id] = level + 1;

          if (id === "hotterFurnace") {
            state.orePerSecondBonus += def.bonusPerLevel;
            appendLog(
              `Upgrade: <span class="success">Hotter Furnace</span> ‚Üí Ore rate boosted by <span class="highlight">${def.bonusPerLevel.toFixed(
                2
              )}/s</span>.`
            );
          } else if (id === "autoSmelter") {
            state.autoSmeltRate += def.bonusPerLevel;

            // First time unlocking Auto Smelter: turn it ON by default
            if (state.upgrades.autoSmelter === 1 && state.autoSmeltRate > 0) {
              state.autoSmelterEnabled = true;
              appendLog(
                `Upgrade: <span class="success">Auto Smelter</span> unlocked and <span class="highlight">enabled</span>. It now auto-smelts Ore into Alloys.`
              );
            } else {
              appendLog(
                `Upgrade: <span class="success">Auto Smelter</span> ‚Üí Auto smelt boosted by <span class="highlight">${def.bonusPerLevel.toFixed(
                  2
                )} Alloys/s</span>.`
              );
            }
          } else if (id === "efficientForge") {
            state.forgeMultiplier += def.bonusPerLevel;
            appendLog(
              `Upgrade: <span class="success">Efficient Forge</span> ‚Üí Forge multiplier increased by <span class="highlight">${def.bonusPerLevel.toFixed(
                1
              )}x</span>.`
            );
          }

          updateUI();
          saveState();
        }

        // Events
        btnSmelt.addEventListener("click", smeltOre);
        btnForge.addEventListener("click", forgeBars);
        btnEpoch.addEventListener("click", forgeEpochCore);
        btnTimeSurge.addEventListener("click", activateTimeSurge);
        btnToggleAuto.addEventListener("click", toggleAutoSmelter);

        document.addEventListener("keydown", (e) => {
          if (e.target.tagName === "INPUT" || e.target.tagName === "TEXTAREA")
            return;
          if (e.key === "s" || e.key === "S") {
            e.preventDefault();
            smeltOre();
          } else if (e.key === "f" || e.key === "F") {
            e.preventDefault();
            forgeBars();
          }
        });

        upgradesListEl.addEventListener("click", (e) => {
          const btn = e.target.closest("[data-upgrade-button]");
          if (!btn) return;
          const upgradeEl = btn.closest(".upgrade");
          if (!upgradeEl) return;
          const id = upgradeEl.getAttribute("data-upgrade-id");
          purchaseUpgrade(id);
        });

        resetBtn.addEventListener("click", () => {
          if (
            confirm(
              "Reset Temporal Forge? This clears all Ore, Alloys, Bars, Epoch Cores, milestones, and upgrades."
            )
          ) {
            resetState();
          }
        });

        window.addEventListener("beforeunload", saveState);

        // Init
        loadState();
        updateUI();
        computeDayRail();
        saveStatusEl.innerHTML = "Save: <span>Ready</span>";
        requestAnimationFrame(gameLoop);
      })();
    </script>
  </body>
</html>
