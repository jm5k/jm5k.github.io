<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<title>Multi-Clock | 24-Hour Linear Clock by jm5k</title>
<meta name="description" content="Multi-timezone 24-hour linear clocks with UTC-offset sorting, pinned favorites, custom labels, gradient progress line, drag & drop reordering, edit-in-place labels, and localStorage persistence." />
<link rel="icon" href="https://jm5k.github.io/profile.png" type="image/png" />

<style>
  :root{
    --bg:#000; --fg:#ccc; --muted:#888; --soft:#aaa;
    --cyan:#0ff; --yellow:#cc9; --rail:#222; --tick:#333; --marker:#0ff;

    /* link/back vars */
    --accent:#00e5ff; --line:#1f1f1f; --chip:#151515; --chip-brd:#222;
  }
  *{box-sizing:border-box}
  body{ background:var(--bg); color:var(--fg); font-family:monospace; margin:0; padding:24px 16px 64px; }
  a{color:var(--cyan); text-decoration:none}
  a:hover{text-decoration:underline}

  .wrap{max-width:960px; margin:0 auto}

  /* ← Back link (top-left) */
  .returnnav {
    max-width:960px; margin:0 auto 10px;
  }
  .returnnav a{
    display:inline-block;
    color:var(--accent);
    text-decoration:none;
    font-size:0.95rem;
    border:1px solid rgba(255,255,255,0.1);
    border-radius:10px;
    padding:6px 12px;
    transition:all .2s ease;
  }
  .returnnav a:hover{
    background:rgba(255,255,255,0.04);
    border-color:var(--accent);
    text-shadow:0 0 6px var(--accent);
  }

  h1{margin:6px 0 10px; font-weight:600; font-size:1.25rem; color:var(--yellow)}
  .sub{margin:0 0 18px; color:var(--muted)}
  hr.nav{border:none; border-top:1px solid rgba(255,255,255,0.1); margin:24px 0}

  .controls{ display:flex; flex-wrap:wrap; gap:10px; align-items:center; margin:16px 0 20px; }
  .controls select,.controls input[type="text"],.controls button{
    background:#111; color:var(--fg); border:1px solid #222; padding:8px 10px; font-family:inherit; border-radius:6px;
  }
  .controls select{min-width:340px}
  .controls input[type="text"]{min-width:240px}
  .controls button{cursor:pointer}
  .controls .hint{color:var(--muted); font-size:0.9rem}

  .clock{
    border:1px solid #111; border-radius:10px; padding:14px 14px 18px; margin:18px 0;
    background:#070707; box-shadow:0 0 0 1px #0a0a0a inset;
  }
  .clock.dragging{opacity:0.6; outline:1px dashed #444}
  .drop-target{outline:1px dashed rgba(0,255,255,0.45)}
  .head{ display:flex; justify-content:space-between; align-items:center; margin-bottom:8px; gap:10px; cursor:grab; user-select:none; }
  .head:active{cursor:grabbing}
  .title{color:var(--cyan); font-weight:600; display:flex; align-items:center; gap:8px}
  .title small{color:var(--muted); font-weight:400}
  .now{color:var(--cyan)}
  .pct{color:var(--yellow)}
  .subline{color:var(--muted); font-size:0.9rem; display:flex; align-items:center; gap:10px}

  .btns{display:flex; gap:6px; align-items:center}
  .btn{
    background:#111; color:#999; border:1px solid #222; padding:2px 6px; border-radius:6px; cursor:pointer;
  }
  .btn:hover{color:#fff; border-color:#333}

  .rail{ position:relative; height:8px; background:var(--rail); border-radius:999px; margin:12px 0 6px; outline:1px solid #0a0a0a; }
  .fill{
    position:absolute; left:0; top:0; bottom:0; width:0%;
    background:linear-gradient(to right, rgba(0,255,255,0.25), rgba(0,255,255,0.9));
    border-radius:999px;
  }
  .marker{
    position:absolute; top:50%; transform:translate(-50%,-50%); height:16px; width:2px; background:var(--marker);
    box-shadow:0 0 6px rgba(0,255,255,0.75);
  }
  .ticks{position:relative; display:flex; justify-content:space-between; font-size:0.8rem}
  .ticks span{color:#555}

  .offset{color:var(--yellow)}
  .label-edit{
    background:#0b0b0b; color:var(--fg); border:1px solid #222; padding:2px 6px; border-radius:6px;
    font-family:inherit; font-size:0.95rem; width:220px;
  }
  .label-actions{display:flex; gap:6px}
</style>
</head>
<body>

  <!-- Top-left return link -->
  <nav class="returnnav" aria-label="Return">
    <a href="index.html">← Back to Linear Clock Lab</a>
  </nav>

  <div class="wrap">
    <h1>24-Hour Linear Clock — Multi-Timezone</h1>
    <p class="sub">
      Add clocks below. The list shows <span class="offset">UTC offsets</span> and is sorted by offset. Pinned favorites appear first.
      Middle-click a clock to remove, or use ✕. Drag the header to reorder, nudge with ▲/▼, and edit labels inline. (Saved locally.)
    </p>

    <div class="controls">
      <select id="tzSelect" title="Choose a timezone"></select>
      <input id="labelInput" type="text" placeholder="Optional label (e.g., London HQ)" />
      <button id="addBtn" aria-label="Add timezone clock">Add</button>
    </div>

    <hr class="nav" />
    <div id="extraClocks"></div>
  </div>

<script>
/* ---------- Constants & DOM ---------- */
const LS_KEY = 'jm5k_multi_clocks_v2'; // version bump for edit-label feature
const tzSelect   = document.getElementById('tzSelect');
const addBtn     = document.getElementById('addBtn');
const labelInput = document.getElementById('labelInput');
const extraClocks= document.getElementById('extraClocks');

/* ---------- Utilities ---------- */
const pad = (n)=> String(n).padStart(2,'0');
const idSafe = (t)=> t.replace(/[^a-z0-9]/gi,'-').toLowerCase();

function getNowInTZ(tz) {
  const parts = new Intl.DateTimeFormat('en-CA', {
    timeZone: tz, year:'numeric', month:'2-digit', day:'2-digit',
    hour:'2-digit', minute:'2-digit', second:'2-digit', hour12:false
  }).formatToParts(new Date());
  const map = Object.fromEntries(parts.map(p => [p.type, p.value]));
  return new Date(`${map.year}-${map.month}-${map.day}T${map.hour}:${map.minute}:${map.second}`);
}
function dayPercent(dateObj){ const s=dateObj.getHours()*3600+dateObj.getMinutes()*60+dateObj.getSeconds(); return (s/86400)*100; }
function fmtTime(d){ return `${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`; }

function getOffsetMinutes(tz, when = new Date()){
  const parts = new Intl.DateTimeFormat('en-US', { timeZone: tz, timeZoneName:'shortOffset' }).formatToParts(when);
  const name = (parts.find(p => p.type === 'timeZoneName') || {}).value || '';
  const m = name.match(/(?:UTC|GMT)([+\-]\d{1,2})(?::?(\d{2}))?/i);
  if (!m){
    const utc = Date.UTC(when.getUTCFullYear(), when.getUTCMonth(), when.getUTCDate(),
                         when.getUTCHours(), when.getUTCMilliseconds());
    const zoned = new Date(when.toLocaleString('en-US', { timeZone: tz })).getTime();
    return Math.round((zoned - utc)/60000);
  }
  const h = parseInt(m[1],10);
  const mm = m[2] ? parseInt(m[2],10) : 0;
  return Math.sign(h) * (Math.abs(h)*60 + mm);
}
function fmtOffset(mins){ const sign = mins>=0?'+':'-'; const absm=Math.abs(mins); const h=String(Math.floor(absm/60)).padStart(2,'0'); const m=String(absm%60).padStart(2,'0'); return `UTC${sign}${h}:${m}`; }
function zonePrettyName(tz){ const p = tz.split('/'); return p.length===1 ? tz : `${p[0]} — ${p.slice(1).join(' / ').replace(/_/g,' ')}`; }

/* ---------- Lists ---------- */
const pinnedZones = ['UTC','America/Phoenix','America/New_York','America/Chicago','America/Denver','America/Los_Angeles','Europe/London','Europe/Berlin','Asia/Tokyo','Asia/Singapore','Australia/Sydney'];
const majorCityKeepList = new Set(['UTC','America/New_York','America/Chicago','America/Denver','America/Los_Angeles','America/Phoenix','Europe/London','Europe/Paris','Europe/Berlin','Asia/Tokyo','Asia/Shanghai','Asia/Singapore','Asia/Kolkata','Australia/Sydney','Pacific/Auckland']);

/* Fallback zone list if supportedValuesOf isn't available */
function getAllTimeZones(){
  if (typeof Intl.supportedValuesOf === 'function'){
    try { const list = Intl.supportedValuesOf('timeZone'); if (Array.isArray(list) && list.length) return list; } catch {}
  }
  return [
    "UTC","America/New_York","America/Chicago","America/Denver","America/Los_Angeles","America/Phoenix",
    "America/Toronto","America/Vancouver","America/Winnipeg","America/Regina","America/Edmonton",
    "Europe/London","Europe/Paris","Europe/Berlin","Europe/Madrid","Europe/Rome","Europe/Amsterdam",
    "Europe/Zurich","Europe/Stockholm","Europe/Athens","Europe/Helsinki",
    "Asia/Tokyo","Asia/Seoul","Asia/Shanghai","Asia/Taipei","Asia/Hong_Kong","Asia/Singapore","Asia/Bangkok","Asia/Kolkata",
    "Australia/Sydney","Australia/Melbourne","Australia/Perth","Pacific/Auckland","Pacific/Honolulu",
    "Africa/Cairo","Africa/Johannesburg","Africa/Nairobi","America/Bogota","America/Lima","America/Mexico_City",
    "America/Sao_Paulo","America/Argentina/Buenos_Aires","America/Santiago","Asia/Dubai","Asia/Riyadh","Asia/Jerusalem"
  ];
}
function dedupeZones(sortedTzList, now = new Date()){
  const seenOffset = new Map(); const result = [];
  for (const tz of sortedTzList){
    const off = getOffsetMinutes(tz, now);
    const keep = majorCityKeepList.has(tz) || pinnedZones.includes(tz);
    if (!seenOffset.has(off)){ seenOffset.set(off, tz); result.push(tz); }
    else if (keep){ result.push(tz); }
  }
  return result;
}

/* ---------- Dropdown ---------- */
function buildDropdown(){
  const all = getAllTimeZones();
  const now = new Date();
  const rows = all.map(tz => ({ tz, offset:getOffsetMinutes(tz, now), isPinned:pinnedZones.includes(tz) }))
                  .map(r => ({...r, label:`${fmtOffset(r.offset)} — ${zonePrettyName(r.tz)}`}));
  rows.sort((a,b) => (a.offset - b.offset) || a.tz.localeCompare(b.tz));

  const deduped = new Set(dedupeZones(rows.map(r=>r.tz), now));
  const pinned = rows.filter(r => r.isPinned);
  const others = rows.filter(r => !r.isPinned && deduped.has(r.tz));

  tzSelect.innerHTML = '';
  if (pinned.length){
    const grp = document.createElement('optgroup'); grp.label = '★ Pinned';
    for (const r of pinned){ const o=document.createElement('option'); o.value=r.tz; o.textContent=r.label; o.dataset.pinned='true'; grp.appendChild(o); }
    tzSelect.appendChild(grp);
  }
  const grp2 = document.createElement('optgroup'); grp2.label = 'Time Zones';
  for (const r of others){ const o=document.createElement('option'); o.value=r.tz; o.textContent=r.label; grp2.appendChild(o); }
  tzSelect.appendChild(grp2);

  if (tzSelect.options.length > 0) tzSelect.selectedIndex = 0;
}

/* ---------- Persistence ---------- */
function saveClocks(){
  try { localStorage.setItem(LS_KEY, JSON.stringify(clocks)); } catch {}
}
function loadClocks(){
  try {
    const raw = localStorage.getItem(LS_KEY);
    if (!raw) return [];
    const arr = JSON.parse(raw);
    if (Array.isArray(arr)) {
      return arr.map(x => ({ tz: String(x.tz || ''), label: String(x.label || '') })).filter(x => x.tz);
    }
  } catch {}
  return [];
}

/* ---------- Clocks & Reorder ---------- */
let clocks = []; // ordered { tz, label }

function createClockCard(entry){
  const { tz, label } = entry;
  const id = `clock-${idSafe(tz)}`;
  if (document.getElementById(id)) return null;

  const el = document.createElement('section');
  el.className = 'clock'; el.id = id; el.dataset.tz = tz; el.draggable = true;

  const off = fmtOffset(getOffsetMinutes(tz));
  const pretty = zonePrettyName(tz);

  el.innerHTML = `
    <div class="head" title="Drag to reorder">
      <div class="title">
        <span class="offset">${off}</span> — 
        <span class="pretty">${pretty}</span>
        <span class="sep" style="margin:0 2px;">·</span>
        <small class="label-view">${label ? escapeHtml(label) : ''}</small>
        <span class="label-editor" style="display:none;">
          <input class="label-edit" type="text" value="${escapeAttr(label || '')}" placeholder="Label (optional)" />
          <span class="label-actions">
            <button class="btn btn-save"  title="Save label">Save</button>
            <button class="btn btn-cancel" title="Cancel">Cancel</button>
          </span>
        </span>
      </div>
      <div class="btns">
        <button class="btn btn-edit"    title="Edit label">Edit</button>
        <button class="btn move-btn" data-dir="-1" title="Move up">▲</button>
        <button class="btn move-btn" data-dir="1"  title="Move down">▼</button>
        <div class="now">--:--:--</div>
        <button class="btn remove-btn" title="Remove this clock" aria-label="Remove">✕</button>
      </div>
    </div>

    <div class="rail"><div class="fill"></div><div class="marker" style="left:0%"></div></div>
    <div class="ticks"><span>00:00</span><span>06:00</span><span>12:00</span><span>18:00</span><span>24:00</span></div>
    <div class="subline"><span class="pct">0.00%</span> of day elapsed</div>
  `;

  // remove
  el.querySelector('.remove-btn').addEventListener('click', () => { removeClock(tz); saveClocks(); });
  el.addEventListener('auxclick', (e) => { if (e.button === 1) { removeClock(tz); saveClocks(); }});

  // arrows
  el.querySelectorAll('.move-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const dir = parseInt(btn.dataset.dir, 10);
      nudgeClock(tz, dir);
      saveClocks();
    });
  });

  // drag & drop
  el.addEventListener('dragstart', (e) => { e.dataTransfer.setData('text/plain', tz); el.classList.add('dragging'); });
  el.addEventListener('dragend', () => { el.classList.remove('dragging'); document.querySelectorAll('.drop-target').forEach(dt => dt.classList.remove('drop-target')); });
  el.addEventListener('dragover', (e) => { e.preventDefault(); el.classList.add('drop-target'); });
  el.addEventListener('dragleave', () => { el.classList.remove('drop-target'); });
  el.addEventListener('drop', (e) => {
    e.preventDefault(); el.classList.remove('drop-target');
    const draggedTz = e.dataTransfer.getData('text/plain'); if (draggedTz && draggedTz !== tz) { reorderByDrop(draggedTz, tz); saveClocks(); }
  });

  // label editing
  const btnEdit  = el.querySelector('.btn-edit');
  const editor   = el.querySelector('.label-editor');
  const view     = el.querySelector('.label-view');
  const sep      = el.querySelector('.sep');
  const input    = el.querySelector('.label-edit');
  const btnSave  = el.querySelector('.btn-save');
  const btnCancel= el.querySelector('.btn-cancel');

  function openEditor(){
    editor.style.display = 'inline-flex';
    view.style.display   = 'none';
    sep.style.display    = 'none';
    input.focus();
    input.select();
  }
  function closeEditor(){
    editor.style.display = 'none';
    const has = (view.textContent || '').trim().length > 0;
    view.style.display   = has ? 'inline' : 'none';
    sep.style.display    = has ? 'inline' : 'none';
  }
  function commitLabel(){
    const val = input.value.trim();
    const idx = clocks.findIndex(c => c.tz === tz);
    if (idx >= 0){
      clocks[idx].label = val;
      view.textContent = val;
      view.style.display = val ? 'inline' : 'none';
      sep.style.display  = val ? 'inline' : 'none';
      saveClocks();
      closeEditor();
    }
  }

  btnEdit.addEventListener('click', openEditor);
  btnSave.addEventListener('click', commitLabel);
  btnCancel.addEventListener('click', () => { input.value = view.textContent || ''; closeEditor(); });
  input.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') commitLabel();
    else if (e.key === 'Escape') { input.value = view.textContent || ''; closeEditor(); }
  });

  extraClocks.appendChild(el);
  return el;
}

// simple escaping helpers
function escapeHtml(s){ return s.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
function escapeAttr(s){ return escapeHtml(s).replace(/"/g,'&quot;'); }

function tickClock(el, tz){
  const now = getNowInTZ(tz);
  const pct = dayPercent(now);
  el.querySelector('.fill').style.width = pct + '%';
  el.querySelector('.marker').style.left = pct + '%';
  el.querySelector('.pct').textContent = `${pct.toFixed(2)}%`;
  el.querySelector('.now').textContent = fmtTime(now);
}
function startClock(entry){
  const el = createClockCard(entry);
  if (!el) return;
  const loop = () => tickClock(el, entry.tz);
  loop(); el._timer = setInterval(loop, 1000);
}
function stopAll(){
  document.querySelectorAll('.clock').forEach(el => { if (el._timer) clearInterval(el._timer); });
}
function removeClock(tz){
  clocks = clocks.filter(c => c.tz !== tz);
  const el = document.getElementById(`clock-${idSafe(tz)}`);
  if (el && el._timer) clearInterval(el._timer);
  if (el) el.remove();
  renderEmptyState();
}
function nudgeClock(tz, dir){
  const i = clocks.findIndex(c => c.tz === tz);
  if (i < 0) return;
  const j = i + dir;
  if (j < 0 || j >= clocks.length) return;
  [clocks[i], clocks[j]] = [clocks[j], clocks[i]];
  rerender();
}
function reorderByDrop(draggedTz, targetTz){
  const from = clocks.findIndex(c => c.tz === draggedTz);
  const to   = clocks.findIndex(c => c.tz === targetTz);
  if (from < 0 || to < 0 || from === to) return;
  const [moved] = clocks.splice(from, 1);
  clocks.splice(to, 0, moved);
  rerender();
}
function rerender(){
  stopAll();
  extraClocks.innerHTML = '';
  clocks.forEach(startClock);
  renderEmptyState();
}

/* ---------- Persistence & Init ---------- */
function renderEmptyState(){
  if (clocks.length === 0 && !document.getElementById('empty-note')){
    const p = document.createElement('p'); p.id='empty-note'; p.className='sub'; p.textContent='No clocks added yet. Use the dropdown and Add button.'; extraClocks.appendChild(p);
  } else if (clocks.length > 0){
    const n = document.getElementById('empty-note'); if (n) n.remove();
  }
}

/* ---------- Add / Init ---------- */
addBtn.addEventListener('click', () => {
  const tz = tzSelect.value;
  if (!tz) return;
  const label = (labelInput.value || '').trim();
  if (clocks.some(c => c.tz === tz)) return;
  clocks.push({ tz, label });
  const empty = document.getElementById('empty-note'); if (empty) empty.remove();
  startClock({ tz, label });
  labelInput.value = '';
  saveClocks();
});
tzSelect.addEventListener('keydown', (e) => { if (e.key === 'Enter') addBtn.click(); });
labelInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') addBtn.click(); });

function init(){
  buildDropdown();
  clocks = loadClocks();
  if (clocks.length) clocks.forEach(startClock);
  renderEmptyState();
}
init();
</script>

<footer style="text-align:center; color:#666; font-size:0.85rem; margin-top:40px;">
  © 2025 jm5k
</footer>
</body>
</html>
