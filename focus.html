<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>FocusLine Pomodoro — jm5k</title>
<meta name="description" content="A minimalist, linear Pomodoro timer with local time bar, note capture, and subtle progress visualization. Built by jm5k.">

<style>
  :root{
    --bg:#0c0c0c; --fg:#eaeaea; --muted:#a9a9a9; --line:#1f1f1f; --accent:#00e5ff;
    --work:#00e5ff; --break:#6be675; --long:#7aa0ff; --danger:#ff5a5a;
    --radius:14px; --chip:#151515; --chip-brd:#222; --ok:#70e69f; --warn:#ffd27d;
  }
  @media (prefers-color-scheme: light){
    :root{ --bg:#ffffff; --fg:#0f0f10; --muted:#5a5a5a; --line:#ececec;
      --accent:#00a8c6; --chip:#f6f6f6; --chip-brd:#e6e6e6 }
  }
  *{ box-sizing:border-box }
  html,body{ height:100% }
  body{
    margin:0;
    font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;
    background:var(--bg); color:var(--fg);
    display:grid; place-items:start center;
  }
  main{ width:min(980px,94vw); margin:40px 0 60px }

  header{ margin-bottom:10px; position:relative; }
  .brand{ font-weight:600; font-size:1.2em; letter-spacing:.2px; margin-bottom:4px; text-align:center; }

  /* Top-left return link */
  .returnlink{
    position:absolute; left:0; top:0;
    transform:translateY(-6px);
    font-size:14px;
  }
  .returnlink a{
    color:var(--accent); text-decoration:none;
    border:1px solid var(--line); border-radius:10px;
    padding:6px 10px; display:inline-block;
    transition:border-color .2s ease, background .2s ease, text-shadow .2s ease;
  }
  .returnlink a:hover{
    background:rgba(255,255,255,0.04);
    border-color:var(--accent);
    text-shadow:0 0 6px var(--accent);
  }

  /* Cards */
  .card{
    background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.05));
    border:1px solid var(--line);
    border-radius: var(--radius);
    padding:18px;
  }

  /* FocusLine */
  .phase-row{ display:flex; justify-content:space-between; align-items:center; gap:12px; margin-bottom:10px }
  .phase-label{ font-weight:600; letter-spacing:.3px }
  .time-label{ font-variant-numeric:tabular-nums; font-size:clamp(20px, 4vw, 36px) }
  .bar-wrap{
    position:relative; width:100%; height:22px; border-radius:999px;
    background:var(--line); overflow:hidden;
    box-shadow: inset 0 0 0 1px rgba(255,255,255,0.04);
    margin:10px 0 14px;
  }
  .bar{ position:absolute; inset:0 auto 0 0; width:0%;
    background: linear-gradient(90deg, rgba(255,255,255,.2), rgba(255,255,255,0) 30%), var(--work);
    transition: background-color .25s ease;
  }
  .controls{ display:flex; flex-wrap:wrap; gap:10px; align-items:center; margin:6px 0 6px }
  button{ cursor:pointer; font-weight:600; border-radius:10px; padding:8px 12px; border:1px solid var(--line); background:#151515; color:var(--fg); }
  button:hover{ border-color:#3a3a3a }
  button.primary{ background:var(--accent); color:#00141a; border-color:transparent }
  button.danger{ background:#201414; border-color:#3a1a1a; color:#ffbdbd }
  .grid{ display:grid; gap:10px; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); margin-top:10px }
  .field{ border:1px solid var(--line); border-radius:10px; padding:10px 12px; background:#0f0f0f }
  .field label{ display:block; font-size:12px; color:var(--muted); margin-bottom:6px }
  .field input[type="number"]{ width:100%; background:transparent; border:none; color:var(--fg); font:600 16px/1.2 inherit; outline:none; -moz-appearance:textfield; }
  .field input::-webkit-outer-spin-button,.field input::-webkit-inner-spin-button{ -webkit-appearance:none; margin:0 }
  .toggles{ display:flex; gap:16px; align-items:center; margin-top:8px; color:var(--muted) }
  .toggles label{ display:flex; align-items:center; gap:8px; cursor:pointer; user-select:none }
  .sub{ display:flex; justify-content:space-between; align-items:center; gap:12px; margin-top:8px; color:var(--muted); font-size:14px }
  .kbd{ font-variant-numeric:tabular-nums; background:#151515; border:1px solid var(--line); padding:2px 6px; border-radius:6px }
  .pill{ padding:2px 8px; border:1px solid var(--line); border-radius:999px; font-size:12px; color:var(--muted) }
  .ok{ color:var(--ok) }

  /* Local linear clock */
  .clock-bar{
    margin:18px 0;
    background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.05));
    border:1px solid var(--line);
    border-radius:var(--radius);
    padding:10px 14px;
    text-align:center;
  }
  .clock-labels{
    display:flex; justify-content:space-between; font-size:14px; color:var(--muted);
    margin-bottom:6px; font-variant-numeric:tabular-nums;
  }
  .clock-rail{ position:relative; height:10px; background:var(--line); border-radius:999px; overflow:hidden; }
  .clock-progress{
    position:absolute; left:0; top:0; bottom:0; width:0%;
    background:linear-gradient(90deg, var(--accent), transparent);
    transition:width 1s linear;
  }

  /* Notes */
  .notes-head{ display:flex; align-items:center; justify-content:space-between; gap:8px; margin-bottom:10px }
  .notes-title{ font-weight:600 }
  .notes-help{ color:var(--muted); font-size:12px }
  .note-in{ display:flex; gap:8px; align-items:flex-start; margin:8px 0 12px }
  .note-in textarea{
    flex:1; min-height:80px; max-height:240px; resize:vertical; background:var(--chip); color:var(--fg);
    border:1px solid var(--chip-brd); border-radius:10px; padding:10px 12px; outline:none;
  }
  .note-actions{ display:flex; gap:8px; flex-wrap:wrap }
  .tools{ display:flex; gap:8px; align-items:center; flex-wrap:wrap }
  .tools input[type="search"]{
    background:var(--chip); color:var(--fg); border:1px solid var(--chip-brd); border-radius:10px; padding:8px 12px; width:180px;
  }
  .note-list{ display:flex; flex-direction:column; gap:8px; margin-top:10px }
  .note{ display:flex; gap:10px; align-items:flex-start; padding:10px 12px; background:#0f0f0f; border:1px solid var(--line); border-radius:10px }
  .note[draggable="true"]{ cursor:grab }
  .note.dragging{ opacity:.5 }
  .note .meta{ color:var(--muted); font-size:12px }
  .note .txt{ white-space:pre-wrap; line-height:1.35 }
  .note .grow{ flex:1 }
  .note .btns{ display:flex; gap:6px }
  .done{ text-decoration:line-through; opacity:.7 }
  .empty{ color:var(--muted); text-align:center; border:1px dashed var(--line); border-radius:10px; padding:20px }

  /* Instructions */
  .instructions h3{ margin:0 0 8px 0; font-size:1.05rem }
  .instructions .muted{ color:var(--muted) }
  .instructions ul{ margin:10px 0 0 18px; padding:0 }
  .instructions li{ margin:6px 0 }

  footer{ margin-top:18px; color:var(--muted); font-size:14px }
</style>
</head>
<body>
<main>
  <header>
    <div class="returnlink"><a href="index.html">← Back to Linear Clock Lab</a></div>
    <div class="brand">FocusLine Pomodoro</div>
  </header>

  <!-- TIMER -->
  <section class="card" aria-live="polite">
    <div class="phase-row">
      <div class="phase-label" id="phaseLabel">Work</div>
      <div class="time-label" id="timeLabel">25:00</div>
    </div>

    <div class="bar-wrap" role="progressbar" aria-valuemin="0" aria-valuenow="0" aria-valuemax="100" aria-label="Pomodoro progress">
      <div class="bar" id="bar"></div>
    </div>

    <div class="controls">
      <button id="startPause" class="primary">Start</button>
      <button id="reset">Reset</button>
      <button id="skip">Skip</button>
      <span class="pill" id="cyclePill">Cycle 1/4</span>
    </div>

    <div class="grid">
      <div class="field"><label for="workMins">Work (minutes)</label><input id="workMins" type="number" min="5" max="120" value="25"></div>
      <div class="field"><label for="shortMins">Short Break</label><input id="shortMins" type="number" min="3" max="60" value="5"></div>
      <div class="field"><label for="longMins">Long Break</label><input id="longMins" type="number" min="5" max="90" value="15"></div>
      <div class="field"><label for="cycles">Cycles until Long Break</label><input id="cycles" type="number" min="2" max="12" value="4"></div>
    </div>

    <div class="toggles">
      <label><input id="autoAdvance" type="checkbox" checked> Auto-advance</label>
      <label><input id="soundOn" type="checkbox"> Chime on complete</label>
    </div>

    <div class="sub">
      <div><span id="statusMsg" class="ok">Ready</span> · Today: <strong id="todayMin">0</strong> min</div>
      <div class="muted">
        Shortcuts: <span class="kbd">Space</span> start/pause <span class="kbd">S</span> skip <span class="kbd">R</span> reset <span class="kbd">N</span> note
      </div>
    </div>
  </section>

  <!-- LOCAL TIME LINEAR CLOCK -->
  <section class="clock-bar" aria-label="Local time progress">
    <div class="clock-labels">
      <span id="clockTimeLabel">00:00</span>
      <span>Local Time</span>
      <span id="clockPercent">0%</span>
    </div>
    <div class="clock-rail"><div class="clock-progress" id="clockProgress"></div></div>
  </section>

  <!-- NOTES -->
  <aside class="card" aria-label="Capture Notes">
    <div class="notes-head">
      <div class="notes-title">Capture Notes</div>
      <div class="notes-help">Saved locally — no accounts</div>
    </div>
    <div class="note-in"><textarea id="noteBox" placeholder="Dump it here so your brain can get back to work..."></textarea></div>
    <div class="note-actions">
      <button id="addNote" class="primary">Add Note</button>
      <button id="addTimestamp" class="nav-pill">Insert Timestamp</button>
      <div class="tools">
        <input id="noteSearch" type="search" placeholder="Search…">
        <button id="exportTxt" class="nav-pill" title="Export as .txt">Export .txt</button>
        <button id="exportJson" class="nav-pill" title="Export as .json">Export .json</button>
        <button id="clearDone" class="nav-pill" title="Remove all done notes">Clear Done</button>
        <button id="clearAll" class="danger" title="Remove all notes">Clear All</button>
      </div>
    </div>
    <div id="noteList" class="note-list"></div>
    <div id="noteEmpty" class="empty" hidden>Nothing yet. Press <span class="kbd">N</span> to jot a thought.</div>
  </aside>

  <!-- INSTRUCTIONS -->
  <section class="card instructions" aria-label="How to use FocusLine and Notes">
    <h3>How to Use FocusLine & Notes</h3>
    <p class="muted"><strong>Note philosophy:</strong> Ideas are welcomed—but not right now. During a work block, capture the thought in seconds and return to the task. You protect deep focus today and gain an actionable list to execute later.</p>
    <ul>
      <li><strong>Pick your lengths:</strong> Set <em>Work</em>, <em>Short Break</em>, <em>Long Break</em>, and cycles. Your choices auto-save.</li>
      <li><strong>Start the timer:</strong> Press <span class="kbd">Space</span> or click <em>Start</em>. Pause with <span class="kbd">Space</span>, <em>Reset</em> if you need a clean slate.</li>
      <li><strong>Auto-advance:</strong> When a block completes, it moves on automatically (toggle under settings). Enable chime if you want an audio cue.</li>
      <li><strong>Today’s totals:</strong> Completed work minutes are tallied under “Today.” Skipping mid-block still credits full minutes worked so far.</li>
      <li><strong>Local time bar:</strong> The thin bar shows how far through the day you are, in real time. It’s there to keep perspective, not pressure.</li>
      <li><strong>Capture Notes fast:</strong> Hit <span class="kbd">N</span> to jump to the box. <span class="kbd">Ctrl/Cmd+Enter</span> to save. Insert a timestamp to anchor context.</li>
      <li><strong>Manage notes:</strong> Mark done, edit, drag to reorder, or use ↑/↓. Search filters live. <em>Clear Done</em> cleans completed noise.</li>
      <li><strong>Export anytime:</strong> Save a .txt for reading or a .json for backup/import. Everything (settings + notes) is stored locally in your browser.</li>
      <li><strong>Privacy:</strong> No accounts, no tracking, no sync. If you want cross-device later, export/import or we can add an opt-in backend.</li>
    </ul>
  </section>

  <footer>© 2025 <strong>jm5k</strong> — No tracking. Your data stays in your browser.</footer>
</main>

<!-- Chime -->
<audio id="ding" preload="auto"><source src="data:audio/wav;base64,UklGRkQAAABXQVZFZm10IBIAAAABAAEAESsAACJWAAACABYAaW5mbyBKa2IAAAAAAAAAPwAAAP///wAAAP///wAAAP///wAAAP///wAAAP///wAA" type="audio/wav"></audio>

<script>
(function(){
  // ------- Elements
  const $ = (q)=>document.querySelector(q);
  const els = {
    bar: $('#bar'), timeLabel: $('#timeLabel'), phaseLabel: $('#phaseLabel'),
    startPause: $('#startPause'), reset: $('#reset'), skip: $('#skip'),
    work: $('#workMins'), short: $('#shortMins'), long: $('#longMins'), cycles: $('#cycles'),
    autoAdvance: $('#autoAdvance'), soundOn: $('#soundOn'), status: $('#statusMsg'),
    todayMin: $('#todayMin'), ding: $('#ding'), cyclePill: $('#cyclePill'),
    progressbar: document.querySelector('.bar-wrap'),
    // local clock
    clockProgress: $('#clockProgress'), clockTimeLabel: $('#clockTimeLabel'), clockPercent: $('#clockPercent'),
    // notes
    noteBox: $('#noteBox'), addNote: $('#addNote'), addTimestamp: $('#addTimestamp'),
    noteList: $('#noteList'), noteEmpty: $('#noteEmpty'), noteSearch: $('#noteSearch'),
    exportTxt: $('#exportTxt'), exportJson: $('#exportJson'), clearAll: $('#clearAll'), clearDone: $('#clearDone'),
    notifyLink: $('#notifyLink') // (now unused in header; kept to avoid js errors if referenced)
  };

  // ------- Timer state
  const Phases = { Work:'Work', Short:'Short Break', Long:'Long Break' };
  const LS_TIMER = 'focusline:v1';
  const HISTORY_KEY = 'focusline:history';
  let state = { phase:Phases.Work, cycle:1, running:false, startEpoch:0, durationMs:25*60*1000, elapsedMs:0 };

  function msForPhase(p){
    if(p===Phases.Work) return +els.work.value*60000;
    if(p===Phases.Short) return +els.short.value*60000;
    return +els.long.value*60000;
  }

  function loadTimer(){
    try{
      const saved = JSON.parse(localStorage.getItem(LS_TIMER) || '{}');
      if(saved.work) els.work.value = saved.work;
      if(saved.short) els.short.value = saved.short;
      if(saved.long) els.long.value = saved.long;
      if(saved.cycles) els.cycles.value = saved.cycles;
      if(saved.autoAdvance !== undefined) els.autoAdvance.checked = saved.autoAdvance;
      if(saved.soundOn !== undefined) els.soundOn.checked = saved.soundOn;
      const hist = JSON.parse(localStorage.getItem(HISTORY_KEY) || '[]'); pruneHistory(hist);
      els.todayMin.textContent = minutesToday(hist);
    }catch{}
    setPhase(Phases.Work, false);
    updateUI();
  }

  function saveTimer(){
    localStorage.setItem(LS_TIMER, JSON.stringify({
      work:+els.work.value, short:+els.short.value, long:+els.long.value,
      cycles:+els.cycles.value, autoAdvance:els.autoAdvance.checked, soundOn:els.soundOn.checked
    }));
  }

  function pruneHistory(hist){
    const cutoff = Date.now() - 7*24*60*60*1000;
    let changed=false;
    for(let i=hist.length-1;i>=0;i--) if(hist[i].t < cutoff){ hist.splice(i,1); changed=true; }
    if(changed) localStorage.setItem(HISTORY_KEY, JSON.stringify(hist));
  }
  function minutesToday(hist){
    const start = new Date(); start.setHours(0,0,0,0);
    const t0 = +start;
    return Math.round(hist.filter(x=>x.t>=t0).reduce((a,b)=>a+b.m,0));
  }
  function addHistory(minutes){
    if(!minutes || minutes<0) return;
    const hist = JSON.parse(localStorage.getItem(HISTORY_KEY) || '[]');
    hist.push({ t: Date.now(), m: minutes });
    pruneHistory(hist);
    localStorage.setItem(HISTORY_KEY, JSON.stringify(hist));
    els.todayMin.textContent = minutesToday(hist);
  }

  function setPhase(phase, announce=true){
    state.phase = phase; state.durationMs = msForPhase(phase);
    state.elapsedMs = 0; state.startEpoch = 0;
    const color = phase===Phases.Work ? 'var(--work)' : (phase===Phases.Short ? 'var(--break)' : 'var(--long)');
    els.bar.style.background = `linear-gradient(90deg, rgba(255,255,255,.2), rgba(255,255,255,0) 30%), ${color}`;
    els.phaseLabel.textContent = phase;
    if(announce) speak(`${phase} started`);
    updateUI();
  }

  function speak(msg){
    els.status.textContent = msg;
    if ('Notification' in window && Notification.permission==='granted'){
      try{ new Notification('FocusLine', { body: msg }); }catch{}
    }
  }

  function format(ms){
    const t = Math.max(0, Math.round(ms/1000));
    const m = Math.floor(t/60), s = t%60;
    return `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
  }

  let rafId=0;
  function tick(){
    if(state.running){
      const now = performance.now();
      state.elapsedMs = now - state.startEpoch;
      if(state.elapsedMs >= state.durationMs){ finishPhase(); }
      updateUI();
    }
    rafId = requestAnimationFrame(tick);
  }

  function start(){
    if(state.running) return;
    state.running = true;
    const now = performance.now();
    state.startEpoch = state.startEpoch===0 ? now : (now - state.elapsedMs);
    els.startPause.textContent = 'Pause'; els.startPause.classList.add('primary');
    speak('Timer started');
  }

  function pause(){
    if(!state.running) return;
    state.running = false;
    els.startPause.textContent = 'Start';
    speak('Paused');
  }

  function reset(){
    const wasRunning = state.running;
    state.running = false;
    const prev = state.phase;
    setPhase(prev, false);
    els.startPause.textContent = 'Start';
    if(wasRunning) speak('Reset');
    updateUI();
  }

  function skip(){
    if(state.running && state.phase===Phases.Work){
      const mins = Math.floor(state.elapsedMs/60000);
      if(mins>0) addHistory(mins);
    }
    state.running=false;
    nextPhase();
  }

  function finishPhase(){
    state.running=false;
    if(els.soundOn.checked){
      try{ els.ding.currentTime=0; els.ding.play().catch(()=>{}); }catch{}
    }
    if(state.phase===Phases.Work){
      addHistory(Math.round(state.durationMs/60000));
    }
    speak(`${state.phase} complete`);
    if(els.autoAdvance.checked) nextPhase();
    else {
      els.startPause.textContent = 'Start';
      els.status.textContent = 'Complete · Ready for next';
    }
  }

  function nextPhase(){
    const totalCycles = +els.cycles.value;
    if(state.phase===Phases.Work){
      if(state.cycle >= totalCycles){ setPhase(Phases.Long); state.cycle = 1; }
      else { setPhase(Phases.Short); state.cycle++; }
    } else {
      setPhase(Phases.Work);
    }
    els.startPause.textContent = 'Start';
    updateUI();
  }

  function updateUI(){
    const p = Math.max(0, Math.min(1, state.elapsedMs / state.durationMs));
    els.bar.style.width = (p*100).toFixed(4)+'%';
    els.progressbar.setAttribute('aria-valuenow', Math.round(p*100));
    els.timeLabel.textContent = format(state.durationMs - state.elapsedMs);
    els.cyclePill.textContent = `${state.phase===Phases.Work?'Cycle':'Break'} ${state.phase===Phases.Work?state.cycle:'·'} / ${els.cycles.value}`;
    saveTimer();
  }

  // Inputs
  els.startPause.addEventListener('click', ()=> state.running ? pause() : start());
  els.reset.addEventListener('click', reset);
  els.skip.addEventListener('click', skip);

  [els.work, els.short, els.long, els.cycles].forEach(inp=>{
    inp.addEventListener('change', ()=>{
      if((state.phase===Phases.Work && inp===els.work) ||
         (state.phase===Phases.Short && inp===els.short) ||
         (state.phase===Phases.Long && inp===els.long)){
        const pct = state.durationMs ? (state.elapsedMs/state.durationMs) : 0;
        state.durationMs = msForPhase(state.phase);
        state.elapsedMs = Math.min(state.durationMs, Math.max(0, state.durationMs * pct));
      }
      saveTimer(); updateUI();
    });
  });

  // Keyboard shortcuts
  window.addEventListener('keydown', (e)=>{
    const tag = document.activeElement.tagName;
    const inField = tag==='INPUT' || tag==='TEXTAREA';
    const k = e.key.toLowerCase();
    if(k==='n' && !inField){ e.preventDefault(); els.noteBox.focus(); return; }
    if((e.key==='Enter') && (e.ctrlKey || e.metaKey)){ if(document.activeElement===els.noteBox){ e.preventDefault(); addNote(); } return; }
    if(inField) return;
    if(k===' ' || k==='spacebar'){ e.preventDefault(); state.running ? pause() : start(); }
    else if(k==='s'){ e.preventDefault(); skip(); }
    else if(k==='r'){ e.preventDefault(); reset(); }
  });

  // ------- Local Time Linear Clock
  function updateLocalClock(){
    const now = new Date();
    const hours = now.getHours(), mins = now.getMinutes(), secs = now.getSeconds();
    const pct = ((hours*3600 + mins*60 + secs) / 86400) * 100;
    els.clockProgress.style.width = pct.toFixed(3) + '%';
    els.clockTimeLabel.textContent = now.toLocaleTimeString([], { hour:'2-digit', minute:'2-digit' });
    els.clockPercent.textContent = Math.round(pct) + '%';
  }
  setInterval(updateLocalClock, 1000);
  updateLocalClock();

  // ------- Notes
  const NOTES_KEY = 'focusline:notes:v1';
  const DRAFT_KEY = 'focusline:note:draft';
  let notes = []; // {id, txt, ts, done, order}

  function loadNotes(){
    try{ notes = JSON.parse(localStorage.getItem(NOTES_KEY) || '[]'); }catch{ notes=[]; }
    notes.forEach((n,i)=>{ if(typeof n.order!=='number') n.order=i; });
    els.noteBox.value = localStorage.getItem(DRAFT_KEY) || '';
    renderNotes();
  }
  function saveNotes(){ localStorage.setItem(NOTES_KEY, JSON.stringify(notes)); }

  function escapeHtml(s){ return s.replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }
  function formatTs(ts){
    const d = new Date(ts), pad = (x)=>String(x).padStart(2,'0');
    return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
  }

  function renderNotes(){
    const q = (els.noteSearch.value||'').toLowerCase().trim();
    const filtered = q ? notes.filter(n=>n.txt.toLowerCase().includes(q)) : notes;
    filtered.sort((a,b)=>a.order-b.order);

    els.noteList.innerHTML='';
    if(filtered.length===0){ els.noteEmpty.hidden=false; return; }
    els.noteEmpty.hidden=true;

    filtered.forEach(n=>{
      const li = document.createElement('div');
      li.className='note'; li.setAttribute('draggable','true'); li.dataset.id=n.id;
      li.innerHTML = `
        <input type="checkbox" ${n.done?'checked':''} aria-label="Mark done" />
        <div class="grow">
          <div class="txt ${n.done?'done':''}">${escapeHtml(n.txt)}</div>
          <div class="meta">${formatTs(n.ts)}${n.done?' · done':''}</div>
        </div>
        <div class="btns">
          <button class="nav-pill" data-act="copy" title="Copy">Copy</button>
          <button class="nav-pill" data-act="edit" title="Edit">Edit</button>
          <button class="nav-pill" data-act="up" title="↑">↑</button>
          <button class="nav-pill" data-act="down" title="↓">↓</button>
          <button class="danger" data-act="del" title="Delete">Delete</button>
        </div>`;

      li.querySelector('input[type=checkbox]').addEventListener('change',(e)=>{ n.done=e.target.checked; saveNotes(); renderNotes(); });
      li.querySelectorAll('button').forEach(b=>b.addEventListener('click', ()=>{
        const act=b.dataset.act;
        if(act==='copy'){ navigator.clipboard?.writeText(n.txt); }
        if(act==='edit'){ const t=prompt('Edit note:', n.txt); if(t!==null){ n.txt=t.trim(); saveNotes(); renderNotes(); } }
        if(act==='del'){ notes=notes.filter(x=>x.id!==n.id); saveNotes(); renderNotes(); }
        if(act==='up'){ bump(n.id,-1); }
        if(act==='down'){ bump(n.id,1); }
      }));

      // drag-and-drop swap
      li.addEventListener('dragstart', ()=> li.classList.add('dragging'));
      li.addEventListener('dragend', ()=> li.classList.remove('dragging'));
      li.addEventListener('dragover', (e)=> e.preventDefault());
      li.addEventListener('drop', (e)=>{
        e.preventDefault();
        const dragged=document.querySelector('.note.dragging'); if(!dragged||dragged===li) return;
        swapOrder(dragged.dataset.id, li.dataset.id); saveNotes(); renderNotes();
      });

      document.getElementById('noteList').appendChild(li);
    });
  }

  function bump(id, dir){
    const sorted=[...notes].sort((a,b)=>a.order-b.order);
    const pos=sorted.findIndex(n=>n.id===id); const swapPos=pos+dir;
    if(pos<0 || swapPos<0 || swapPos>=sorted.length) return;
    const a=sorted[pos], b=sorted[swapPos]; const tmp=a.order; a.order=b.order; b.order=tmp;
    saveNotes(); renderNotes();
  }
  function swapOrder(aId,bId){
    const a=notes.find(n=>n.id===aId), b=notes.find(n=>n.id===bId);
    if(!a||!b) return; const t=a.order; a.order=b.order; b.order=t;
  }

  function addNote(){
    const txt=(els.noteBox.value||'').trim(); if(!txt) return;
    const id = crypto?.randomUUID ? crypto.randomUUID() : (Date.now()+Math.random()).toString(36);
    const maxOrder = notes.reduce((m,n)=>Math.max(m,n.order||0), -1);
    notes.push({ id, txt, ts:Date.now(), done:false, order:maxOrder+1 });
    saveNotes(); renderNotes(); els.noteBox.value=''; localStorage.removeItem('focusline:note:draft');
  }

  els.addNote.addEventListener('click', addNote);
  els.addTimestamp.addEventListener('click', ()=>{
    const stamp=`[${formatTs(Date.now())} · ${state.phase}] `;
    const el=els.noteBox; const s=el.selectionStart||0, e=el.selectionEnd||0, v=el.value;
    el.value = v.slice(0,s) + stamp + v.slice(e);
    el.focus(); el.selectionStart = el.selectionEnd = s + stamp.length;
    localStorage.setItem('focusline:note:draft', el.value);
  });
  els.noteBox.addEventListener('input', ()=> localStorage.setItem('focusline:note:draft', els.noteBox.value));
  els.noteSearch.addEventListener('input', renderNotes);
  els.clearAll.addEventListener('click', ()=>{ if(confirm('Delete ALL notes?')){ notes=[]; saveNotes(); renderNotes(); } });
  els.clearDone.addEventListener('click', ()=>{ const before=notes.length; notes=notes.filter(n=>!n.done); if(notes.length!==before){ saveNotes(); renderNotes(); } });

  // Exports
  function download(name, text, mime='text/plain'){
    const blob=new Blob([text],{type:mime}); const url=URL.createObjectURL(blob);
    const a=document.createElement('a'); a.href=url; a.download=name; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
  }
  document.getElementById('exportTxt')?.addEventListener('click', ()=>{
    const lines = notes.sort((a,b)=>a.order-b.order).map(n=>{
      const mark=n.done?'[x]':'[ ]'; return `${mark} ${formatTs(n.ts)} — ${n.txt}`;
    }).join('\n');
    download(`FocusLine_Notes_${new Date().toISOString().slice(0,10)}.txt`, lines);
  });
  document.getElementById('exportJson')?.addEventListener('click', ()=>{
    download(`FocusLine_Notes_${new Date().toISOString().slice(0,10)}.json`, JSON.stringify(notes,null,2), 'application/json');
  });

  // Init
  loadTimer();
  loadNotes();
  requestAnimationFrame(tick);

  // Local time tick
  setInterval(updateLocalClock, 1000);
  updateLocalClock();

})();
</script>
</body>
</html>
